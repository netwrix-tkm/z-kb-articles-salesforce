<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Configure Proxy for RDP Connections (Install/Update Certificate to Prevent RDP Certificate Warnings)</title><meta name="label" content="privilege_secure"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000HRRCA2"/><meta name="Id" content="ka0Qk0000006gqzIAA"/><meta name="LastPublishedDate" content="2024-10-16T13:22:48.000+0000"/><meta name="LastModifiedDate" content="2024-10-16T13:22:48.000+0000"/><meta name="FirstPublishedDate" content="2021-10-12T13:41:40.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="5913"/><meta name="ArticleNumber" content="000005913"/><meta name="description" content="Configure Proxy for RDP Connections (Install/Update Certificate to Prevent RDP Certificate Warnings)"/></head><body><article class=" kb-articles"><div class="Content__c"><h2 id="summary">Summary</h2>
<p>This article outlines the process for install or updating a certificate to prevent RDP certificate warnings during SbPAM workflows.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul><li>
<p>Windows Server must have the <b>Certification Authority</b> and <b>Certification Authority Web Enrollment</b> roles installed and configured, so that the <b>Certification Authority</b> utility can be successfully launched as well as accessed via a web browser (https://&lt;servername&gt;/certsrv).</p>
<p><em><span class="wysiwyg-color-red110"><span><strong>IMPORTANT: </strong>The Certification Authority's post-deployment configuration must be completed after installing both prerequisite roles.</span><br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_0919cb2f-855c-4e9c-9d1e-149f594f5ad7.png"/></span></em><br/> </p>
</li><li>
<p>The domain must have set the <b>Enrollment Policy</b> to enable automatic enrollment and renewal. The <b>Certificate Enrollment Policy</b> for user and computer certificates is done in the <b>Group Policy</b> snap=in -&gt; <b>Default Domain Policy</b> (or another group policy applied to all systems that will access an NPS server on a group-by-group basis). For that:</p>
<ol><li>
<p>On the Domain Controller, open the <b>Group Policy</b> snap-in.</p>
</li><li>
<p>Navigate to <b>Computer configuration/Policies/Windows Settings/Security Settings/Public Key Policies/</b> and enable the <b>Certifcate SErvices - Certificate Enrollment Policy</b>.</p>
</li></ol>
</li></ul>
<h2 id="generate_certificate">Generate Certificate</h2>
<p><i><b>NOTE:</b> If you already have a certificate to install, you can skip to <b><a href="#adding_the_certificate_to_each_sbpam_proxy_server">Adding the Certificate to Each SbPAM Proxy Server</a></b> section below.</i></p>
<ol><li>Open <strong>Certification Authority, </strong>open your CA, right-click <strong>Certificate Templates</strong>, and click <strong>Manage</strong>.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_7ad862da-88e9-4b83-b490-579ac1cb1864.png"/><br/> </li><li>In the <strong>Certificate Templates Console</strong>, right-click <strong>Workstation Authentication</strong>, and click <strong>Duplicate Template</strong>.<br/><br/><img alt="User-added image" height="491" src="kA04u0000000HRRCA2_9a1b4ee9-5ff2-4466-8012-bbb3f876dd53.png" width="500"/><br/> </li><li>On the <strong>General</strong> tab, change the name to <strong>Client-Server Authentication</strong> and enable the <strong>Publish certificate in Active Directory</strong> checkbox.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_75c47a38-3f12-4180-8b93-73a8d8bdef14.png"/><br/> </li><li>On the <strong>Subject Name</strong> tab, enable the <strong>Supply in the request</strong> radio button.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_3e4bd41f-264e-4bf4-8bd5-4ddb12b5a129.png"/></li><li>On the <strong>Extensions </strong>tab, select <strong>Application Policies </strong>and click <strong>Edit</strong>. Click <strong>Add</strong>, then select <strong>Server </strong><br/><strong>Authentication</strong>. Click <strong>OK</strong> until you return to the <strong>Properties of New Template</strong> dialog.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_0371704a-30cf-4d2f-aa11-fbc2a3646171.png"/><br/> </li><li>On the <strong>Security </strong>tab, select <strong>Domain Computers</strong> and enable the checkbox to Allow <strong>Autoenroll</strong>. After, click OK and then close the Certificate Templates Console.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_07f94f2c-584a-4924-8832-508b86c3c067.png"/><br/> </li><li>Back in the <strong>Certification Authority</strong>, right-click <strong>Certificate Templates</strong>, hover over <strong>New</strong>, and click <strong>Certificate Template to Issue.<br/><br/><img alt="User-added image" height="325" src="kA04u0000000HRRCA2_26b3388c-e1e5-42ca-89bc-866ed7f3ac25.png" width="500"/></strong><br/> </li><li>Select<strong> Client-Server Authentication</strong> and click <strong>OK</strong>.<br/><br/><strong><img alt="User-added image" height="318" src="kA04u0000000HRRCA2_6fc1e2df-4505-405d-a639-003a326038da.png" width="500"/></strong><br/> </li><li>
<p>On the desktop, create a text file named request.inf, which contains the following text (change the<br/><span class="wysiwyg-color-red"><strong>RED</strong></span> text to match your server certificate name):</p>
<pre class="ckeditor_codeblock">[Version]
Signature="$Windows NT$"
[NewRequest]
Subject = "CN=<span>sbpam-3.sblab.local</span>"
KeySpec = 1
KeyLength = 2048
Exportable = TRUE
MachineKeySet = FALSE
SMIME = False
PrivateKeyArchive = FALSE
UserProtected = FALSE
UseExistingKeySet = FALSE
ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
ProviderType = 12
RequestType = PKCS10
KeyUsage = 0xa0
HashAlgorithm = SHA256
[Extensions]
2.5.29.17 = "{text}"
_continue_ = "dns=<span>sbpam-3.sblab.local</span>&amp;"
[EnhancedKeyUsageExtension]
OID=1.3.6.1.5.5.7.3.1</pre>
</li><li>
<p>Open Command Prompt as Administrator and change directory (cd) to the Desktop (or wherever you placed your request.inf file) and run:</p>
<pre class="ckeditor_codeblock">certreq -new request.inf rdp.csr</pre>
<br/><img alt="User-added image" height="193" src="kA04u0000000HRRCA2_40586fd2-994d-402b-9d32-3f97110ab540.png" width="500"/><br/> </li><li>To sign the certificate request, use your preferred signing mechanism. Active Directory Certificate Services is used in the following example (https://&lt;servername&gt;/certsrv).<br/><br/><span class="wysiwyg-color-red"><strong><img alt="User-added image" height="103" src="kA04u0000000HRRCA2_0842d2f7-7d7b-4d3a-9e35-2cbaf2cbf774.png" width="500"/><br/><br/><img alt="User-added image" height="196" src="kA04u0000000HRRCA2_d205b0d5-90cd-4ed4-a28f-6453a0cdd463.png" width="500"/></strong></span><br/><br/><span class="wysiwyg-color-black">Click <strong>Request a certificate, </strong>then click <strong>advanced certificate request.</strong></span><br/> </li><li><span class="wysiwyg-color-black">Open the saved certificate signing request (rdp.csr) from Step 10 in Notepad. Copy the certificate request into the <strong>Saved Request</strong> field. Select <strong>Client-Server Authentication</strong> from the <strong>Certificate Template Dropdown</strong>. Click <strong>Submit</strong>.<br/><br/><img alt="User-added image" height="419" src="kA04u0000000HRRCA2_32cd5160-ca50-49e2-8a19-95a3cb63ed99.png" width="500"/></span><br/><br/><span class="wysiwyg-color-black">Leave other settings at default values, and click <strong>Submit</strong>.</span><br/> </li><li><span class="wysiwyg-color-black">Select <strong>DER encoded</strong> and click <strong>Download certificate</strong>.<br/><br/><img alt="User-added image" src="kA04u0000000HRRCA2_2f486068-a15b-433c-a36c-dbbfa4e91578.png"/></span><br/> </li><li><span class="wysiwyg-color-black">Open the downloaded certificate and select <strong>Install Certificate</strong>. Proceed with all default values and complete the wizard.<br/>   <img alt="User-added image" height="328" src="kA04u0000000HRRCA2_ce7af72f-781b-4314-871b-15db488bf6ef.png" width="500"/></span><br/> </li><li><span class="wysiwyg-color-black">To export the certificate, you'll need to view certificates for the current user by launching <strong>certmgr.msc</strong> using Windows' <strong>Run</strong> menu.<br/><br/><img alt="User-added image" height="80" src="kA04u0000000HRRCA2_78511d5a-f0b0-41d0-bda6-a1d8e789ef36.png" width="500"/><br/><br/>Right-click the installed certificate (the certificate using the <strong>Client-Server Authentication </strong>template) and click <strong>Export...</strong>.<br/><br/><img alt="User-added image" height="183" src="kA04u0000000HRRCA2_4d5ea968-b19c-42a1-8b82-e57b37c9661b.png" width="500"/></span><br/> </li><li><span class="wysiwyg-color-black">In the <strong>Certificate Export Wizard</strong>, be sure to change the <strong>Export Private Key</strong> option to <strong>Yes, export the private key</strong>.<br/><br/><img alt="User-added image" height="301" src="kA04u0000000HRRCA2_6c4c5b88-0d85-4450-b38a-77d71b9c3be4.png" width="500"/></span><br/> </li><li><span class="wysiwyg-color-black">For <strong>Export File Format</strong>, select <strong>Personal Information Exchange - PKCS #12 (.PFX)</strong>. The following checkboxes should be selected under that option:<br/><br/><strong>- Include all certificates in the certification path if possible<br/>- Enable certificate privacy</strong><br/><br/><img alt="User-added image" height="422" src="kA04u0000000HRRCA2_b66473fa-cdc6-4941-a266-9c615b8e4967.png" width="500"/></span><br/> </li><li><span class="wysiwyg-color-black">For <strong>Security</strong>, enter a password of your choosing and select the AES256-SHA256 encryption option (3DES is no longer recommended by NIST).<br/><br/></span></li><li><span><i><b><span class="wysiwyg-color-red110">IMPORTANT: </span></b><span class="wysiwyg-color-red110">For</span><b><span class="wysiwyg-color-red110"> "<strong>File to Export"</strong></span></b><span class="wysiwyg-color-red110">, the file name <u>must</u> be </span><b><span class="wysiwyg-color-red110"><strong>rdp.pfx</strong>. </span></b><span class="wysiwyg-color-red110">If it is named anything else, importing the .pfx file on each proxy server will not work.</span></i></span><br/><br/><span class="wysiwyg-color-black"><img alt="User-added image" height="237" src="kA04u0000000HRRCA2_9272031e-a2ee-4aaa-911e-3d7b05ac2bc1.png" width="500"/></span></li><li><span class="wysiwyg-color-black">This certificate can now be imported to each SbPAM Proxy Server.</span></li></ol>
<h3 id="adding_the_certificate_to_each_sbpam_proxy_server"><a id="Adding-the-Certificate-to-Each-SbPAM-Proxy-Server" name="Adding-the-Certificate-to-Each-SbPAM-Proxy-Server"><strong><span class="wysiwyg-color-black">Adding the Certificate to Each SbPAM Proxy Server</span></strong></a></h3>
<ol><li><span class="wysiwyg-color-black">Copy <strong>rdp.pfx</strong> (from the previous steps) to each SbPAM Proxy Server.</span><br/> </li><li>On each SbPAM Proxy Server, run the following command via an elevated <strong>Command Prompt</strong>, and enter the certificate's password when prompted.<br/><br/><span><span class="wysiwyg-color-red110"><em><strong>IMPORTANT: </strong>The path to <strong>sbpam-proxy.exe</strong> may be different depending on the install path you selected when installing SbPAM and/or distributed proxy services.</em></span></span>
<pre class="ckeditor_codeblock">"C:\Program Files\Stealthbits\PAM\ProxyService\sbpam-proxy.exe" ca import -p [PATH]\rdp.pfx</pre>
<br/><span class="wysiwyg-color-red110"><em><img alt="User-added image" height="80" src="kA04u0000000HRRCA2_c65da6e3-9442-4702-bad1-af6991e96735.png" width="500"/></em></span><br/> </li><li><span class="wysiwyg-color-black">The new certificate has now been imported to an SbPAM Proxy Server. Repeat this process for all SbPAM Proxy Servers if using more than one (the default installation of SbPAM uses one proxy service on the SbPAM server itself, however additional proxy services can be distributed).</span></li></ol></div>
</article></body></html>