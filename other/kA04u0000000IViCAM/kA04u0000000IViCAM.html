<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Restore an ACL from SAM SDDL Data (Windows Only)</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IViCAM"/><meta name="Id" content="ka04u000000Hcp2AAC"/><meta name="LastPublishedDate" content="2022-02-01T18:36:55.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:07:54.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:36:55.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7256"/><meta name="ArticleNumber" content="000007256"/><meta name="description" content="360008602431"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> SAM captures permission change before and after data for Windows starting in version 3.1, but it's not easy to restore the ACL within the product.</p><p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Given an SDDL string (which SAM for provides for permission changes on Windows target hosts), it's possible to see what the permissions were, but not straightforward. It's also not straightforward to restore them to what they were before.<br/> </p><p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> Given a BeforeSddl string in SAM data, it should be possible to restore the object to its previous permission state. To do this, we have to construct the ACL and apply it to the target object where the permission change occurred. This can be done in PowerShell.<br/> <br/><span><span><span>#Input the SDDL from source data (all in one line)</span></span></span><br/><span><span><span>$sddl</span></span></span><span><span><span>=</span></span></span><span><span><span>'D:PAI(A;OICI;0x1200a9;;;S-1-5-21-3015364959-2382669265-870162898-1492)(A;OICI;FA;;;S-1-5-21-3015364959-2382669265-870162898-1265)'</span></span></span><br/> <br/><span><span><span>#Input the target object</span></span></span><br/><span><span><span>$TgtPath</span></span></span><span><span><span>=</span></span></span><span><span><span>'C:\Users\User1\Desktop\ACL'</span></span></span><br/> <br/><span><span><span>#identify object type and create ACL object (dependent on object type)</span></span></span><br/><span><span><span>if</span></span></span><span><span>((<span>get-item</span> <span>$TgtPath</span>)<span>.</span>PSIsContainer)</span></span><br/><span><span>{   <span>#Directory</span></span></span><br/><span><span>    <span>$ACLObj</span><span>=</span><span>new-object</span> <span>System.Security.AccessControl.DirectorySecurity</span></span></span><br/><span><span>}</span></span><br/><span><span><span>else</span></span></span><br/><span><span>{   <span>#file</span></span></span><br/><span><span>    <span>$ACLObj</span><span>=</span><span>new-object</span> <span>System.Security.AccessControl.FileSecurity</span></span></span><br/><span><span>}</span></span><br/> <br/><span><span><span>#Add SDDL to ACL Object</span></span></span><br/><span><span><span>$ACLObj</span></span></span><span><span><span>.</span></span></span><span><span>SetSecurityDescriptorSddlForm(<span>$sddl</span>)</span></span><br/> <br/><span><span><span>#Apply SDDL to target object</span></span></span><br/><span><span><span>Set-Acl</span></span></span><span><span> <span>-Path</span> <span>$TgtPath</span> <span>-AclObject</span> <span>$ACLObj </span></span></span><br/> <br/> <br/>Notes: 
</p><ul><li>This has been tested, but not widely field-tested, and does not contain robust error handling
</li><li>Caution should be exercised when changing ACLs in production environments. It's recommended that significant testing be performed prior to implementation.
</li><li>It's not clear from the MSDN documentation whether backup and restore privileges are leveraged in the Set-ACL. In testing, they overwrite blank ACLs without issue 
<ul><li>Local and network paths are supported, but if using a network share, the user must have been granted the ability (on the Share ACL) to change permissions, since backup/restore privileges do not bypass share ACLs</li></ul>
</li><li>Using the technique described in this article, it should be possible to restore ACLs from SAM input in a batch of resources fed into the PowerShell Data Collector via table input.
</li><li>Functionality could be expanded to support registry ACLs, which Set-ACL also supports.
</li><li>It is possible to construct the ACL from scratch instead of from an SDDL string, but that's outside the scope of this article.
</li><li>Set-ACL also allows setting of other parts of the ACL, like Owner, which is covered in a separate KB article (<u>link placeholder</u>)</li></ul> <br/>Set-ACL Documentation - <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl" target="_blank">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl</a><br/> <p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> STEALTHbits File Activity Monitor<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - Windows<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> SAM 3.1+; Tested in PowerShell 5.1<br/><strong><span class="wysiwyg-font-size-large">Dev Ticket:</span></strong> SF-33655, SAFS-16445<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2349<br/></p></div>
</article></body></html>