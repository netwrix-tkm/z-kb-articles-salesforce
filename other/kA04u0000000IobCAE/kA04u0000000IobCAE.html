<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Gather Folder Count and Maximum Folder Depth Outside of StealthAUDIT</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IobCAE"/><meta name="Id" content="ka04u000000HcwOAAS"/><meta name="LastPublishedDate" content="2022-02-01T18:31:41.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:11:45.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:31:41.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7160"/><meta name="ArticleNumber" content="000007160"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Uses custom PowerShell script to enumerate all folders on target share, leveraging Robocopy for backup privilege capabilities and long file path support (similar to how FSAA works).</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Customers sometimes ask for data validation to be performed, and one of the asks for a POC was to "prove" that our data for folder depth (relative to share root, available in the SA_FSAA_SharesTraversalView) matches that collected via an independent routine<br/><br/>Note: This really shouldn't be our responsibility.  It's the customers responsibility to validate their data against whatever they want, and understand the differences.  However, if you're going to do it, anyway, here's some help.  <br/><br/>This script works for local and remote shares. It does not work for local paths. Simply update the path to include a valid share to be analyzed in the $SourcePath parameter, and enter a valid local path to act as the destination folder for the robocopy command. No data will actually be copied. Finally, enter a valid path where the log file will be created.<br/> <br/>The script works by listing the empty folder structure ("L" parameter) that would be created locally and then parsing the log file created by Robocopy to understand depth by measuring the length of the path and subtracting the length of the path with no backslashes.<br/> <br/>Results include the following: </p>
<div class="table-wrap"><table count-columns="2" border="0" width="444" cellspacing="0" cellpadding="0"><tbody><tr><td colspan="1" rowspan="1"><strong><span><span><span>Property</span></span></span></strong></td><td colspan="1" rowspan="1"><strong><span><span><span>Value</span></span></span></strong></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>SourceRoot</span></span></span></td><td colspan="1" rowspan="1"><span><span><span><a target="_blank">\\localhost\Data</a></span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>DestRoot</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>H:\Copy Of Desktop</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>SourceRootDepth</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>0</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>DestRootDepth</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>1</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>DepthDiff</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>-1</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>ShareRootDepth</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>1</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>ShareRootFolder</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>H:\Data</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>MaxDepth</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>0</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>MaxDepthFromVolRoot</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>1</span></span></span></td></tr><tr><td colspan="1" rowspan="1"><span><span><span>DeepestFolderSample</span></span></span></td><td colspan="1" rowspan="1"><span><span><span>  New Dir          2 <a target="_blank">\\localhost\Data\</a></span></span></span></td></tr></tbody></table></div>
<p> <br/><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong>  <br/>Note: Must run as an administrator!<br/> <br/><span><span><span>$SourcePath</span></span></span><span><span><span>=</span></span></span><span><span><span>'\\sbitsinc.com\Public\Professional Services\Customers'</span></span></span><br/><span><span><span>$SourcePath</span></span></span><span><span><span>=</span></span></span><span><span><span>'\\localhost\Data'</span></span></span><br/><span><span><span>$DestPath</span></span></span><span><span><span>=</span></span></span><span><span><span>'H:\Copy Of Desktop'</span></span></span><br/><span><span><span>$LogPath</span></span></span><span><span><span>=</span></span></span><span><span><span>"H:\RoboLog.txt"</span></span></span><br/><span><span><span/></span><br/> <br/><span><span><span>potential options....</span></span></span><br/><span><span><span>/XJ :: eXclude Junction points. (normally included by default).</span></span></span><br/><span><span><span>/SL :: copy symbolic links versus the target</span></span></span><br/> <br/><span><span><span>#&gt;</span></span></span><br/><span><span><span>$logoutput</span></span></span><span><span><span>=</span></span></span><span><span><span>robocopy</span></span></span><span><span> <span>$SourcePath</span> <span>$DestPath</span> <span>*.*</span> <span>/E</span> <span>/B</span> <span>/MIR</span> <span>/UNILOG:</span><span>$LogPath</span> <span>/NFL</span> <span>/L</span> <span>/NP</span> <span>/V</span></span></span><br/><span><span><span>$IsSourceShare</span></span></span><span><span><span>=</span></span></span><span><span><span>if</span></span></span><span><span>(<span>$SourcePath</span><span>[</span><span>0</span><span>]</span> <span>-eq</span> <span>'\'</span>){<span>$True</span>} <span>else</span> {<span>$False</span>}</span></span><br/><span><span><span>if</span></span></span><span><span>(<span>$IsSourceShare</span>){</span></span><br/><span><span>    <span>$TgtHost</span><span>=</span><span>$SourcePath</span><span>[</span><span>2</span><span>..</span>((<span>$SourcePath</span><span>[</span><span>2</span><span>..</span><span>$SourcePath</span><span>.</span>length<span>]-join</span>(<span>''</span>))<span>.</span>IndexOf(<span>'\'</span>)<span>+</span><span>1</span>)<span>]</span> <span>-join</span>(<span>''</span>)</span></span><br/><span><span>    <span>$TgtShare</span><span>=</span>(<span>$SourcePath</span><span>[</span>(<span>3</span><span>+</span><span>$TgtHost</span><span>.</span>Length)<span>..</span>(<span>$SourcePath</span><span>.</span>Length)<span>]</span> <span>-join</span>(<span>''</span>))</span></span><br/><span><span>    <span>if</span>(<span>$TgtShare</span> <span>-like</span> <span>'*\*'</span>){</span></span><br/><span><span>        <span>$TgtShare</span><span>=</span><span>$TgtShare</span><span>[</span><span>0</span><span>..</span>(<span>$TgtShare</span><span>.</span>IndexOf(<span>'\'</span>)<span>-</span><span>1</span>)<span>]</span> <span>-join</span>(<span>''</span>)</span></span><br/><span><span>    }</span></span><br/><span><span>    <span>$Filter</span><span>=</span><span>"Name=""</span><span>$TgtShare</span><span>"""</span></span></span><br/><span><span>    <span>$ShareObj</span><span>=</span><span>gwmi</span> <span>win32_share</span> <span>-ComputerName</span> <span>$TgtHost</span> <span>-Filter</span> <span>$Filter</span></span></span><br/><span><span>    <span>$ShareRootFolder</span><span>=</span><span>$ShareObj</span><span>.</span>Path</span></span><br/><span><span>    <span>$ShareRootDepth</span><span>=</span><span>$ShareRootFolder</span><span>.</span>length <span>-</span> (<span>$ShareRootFolder</span> <span>-replace</span>(<span>'\\'</span><span>,</span><span>''</span>) <span>-join</span>(<span>''</span>))<span>.</span>Length</span></span><br/>   <br/> <br/><span><span>}</span></span><br/><span><span><span>if</span></span></span><span><span>(<span>$IsSourceShare</span> <span>-eq</span> <span>$False</span>){</span></span><br/><span><span>    <span>$SourceRootDepth</span><span>=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"Source"</span> <span>-List</span> <span>|</span> <span>select</span> @{Name<span>=</span><span>"SourceDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>1</span>}} <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>SourceDepth</span></span></span><br/><span><span>    <span>$DestRootDepth</span><span>=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"Dest"</span> <span>-List</span> <span>|</span> <span>select</span> @{Name<span>=</span><span>"DestDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>1</span>}} <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>DestDepth</span></span></span><br/><span><span>    <span>$DepthDiff</span><span>=</span><span>$SourceRootDepth</span> <span>-</span> <span>$DestRootDepth</span></span></span><br/><span><span>    <span>$ShareRootDepth</span><span>=</span><span>0</span></span></span><br/><span><span>    <span>$Folders</span><span>=</span>@()</span></span><br/><span><span>    <span>$Folders</span><span>+=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"New Dir"</span> <span>|</span> <span>select</span> <span>Line</span><span>,</span> @{Name<span>=</span><span>"DestDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>1</span>}}</span></span><br/><span><span>}</span></span><br/><span><span><span>else</span></span></span><span><span>{</span></span><br/><span><span>    <span>$SourceRootDepth</span><span>=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"Source"</span> <span>-List</span> <span>|</span> <span>select</span> @{Name<span>=</span><span>"SourceDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>4</span>}} <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>SourceDepth</span></span></span><br/><span><span>    <span>$DestRootDepth</span><span>=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"Dest"</span> <span>-List</span> <span>|</span> <span>select</span> @{Name<span>=</span><span>"DestDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>1</span>}} <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>DestDepth</span></span></span><br/><span><span>    <span>$DepthDiff</span><span>=</span><span>$SourceRootDepth</span> <span>-</span> <span>$DestRootDepth</span></span></span><br/><span><span>    <span>$Folders</span><span>=</span>@()</span></span><br/><span><span>    <span>$Folders</span><span>+=</span><span>Select-String</span> <span>-path</span> <span>$LogPath</span> <span>-Pattern</span> <span>"New Dir"</span> <span>|</span> <span>select</span> <span>Line</span><span>,</span> @{Name<span>=</span><span>"SourceDepth"</span>;Expression<span>=</span>{<span>$_</span><span>.</span>Line<span>.</span>Length<span>-</span>(<span>$_</span><span>.</span>Line <span>-replace</span>(<span>"\\"</span><span>,</span><span>''</span>))<span>.</span>Length<span>-</span><span>4</span>}}</span></span><br/><span><span>}</span></span><br/><span><span><span>$MaxDepth</span></span></span><span><span><span>=</span></span></span><span><span><span>$Folders</span></span></span><span><span> <span>|</span> <span>Measure-Object</span> <span>-Property</span> <span>SourceDepth</span> <span>-Maximum</span> <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>Maximum</span></span></span><br/><span><span><span>$FolderCount</span></span></span><span><span><span>=</span></span></span><span><span><span>$Folders</span></span></span><span><span> <span>|</span> <span>Measure-Object</span> <span>|</span> <span>select</span> <span>-ExpandProperty</span> <span>Count</span></span></span><br/><span><span><span>$DeepestFolders</span></span></span><span><span><span>=</span></span></span><span><span><span>$Folders</span></span></span><span><span> <span>|</span> <span>?</span>{<span>$_</span><span>.</span>SourceDepth <span>-eq</span> <span>$MaxDepth</span>}</span></span><br/> <br/><span><span><span>$Res</span></span></span><span><span><span>=</span></span></span><span><span><span>''</span></span></span><span><span> <span>|</span> <span>select</span> <span>SourceRoot</span><span>,</span> <span>DestRoot</span><span>,</span> <span>SourceRootDepth</span><span>,</span> <span>DestRootDepth</span><span>,</span> <span>DepthDiff</span><span>,</span> <span>ShareRootDepth</span><span>,</span> <span>ShareRootFolder</span><span>,</span> <span>MaxDepth</span><span>,</span> <span>MaxDepthFromVolRoot</span><span>,</span> <span>DeepestFolderSample</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>SourceRoot<span>=</span><span>$SourcePath</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>DestRoot<span>=</span><span>$DestPath</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>SourceRootDepth<span>=</span><span>$SourceRootDepth</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>DestRootDepth<span>=</span><span>$DestRootDepth</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>DepthDiff<span>=</span><span>$DepthDiff</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>ShareRootFolder<span>=</span><span>$ShareRootFolder</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>ShareRootDepth<span>=</span><span>$ShareRootDepth</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>MaxDepth<span>=</span><span>$MaxDepth</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>MaxDepthFromVolRoot<span>=</span><span>$MaxDepth</span><span>+</span><span>$ShareRootDepth</span></span></span><br/><span><span><span>$Res</span></span></span><span><span><span>.</span></span></span><span><span>DeepestFolderSample<span>=</span><span>$DeepestFolders</span><span>[</span><span>0</span><span>].</span>Line</span></span><br/><span><span><span>$Res </span></span></span><br/> <br/> </span></p>
<p><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 1883</p></div>
</article></body></html>