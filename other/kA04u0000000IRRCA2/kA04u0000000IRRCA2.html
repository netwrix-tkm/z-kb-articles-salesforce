<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>How to Separate SFAM Activity Files into Separate Files for Different Servers</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IRRCA2"/><meta name="Id" content="ka04u000000HcnNAAS"/><meta name="LastPublishedDate" content="2022-02-01T18:45:15.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:07:00.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:45:15.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7388"/><meta name="ArticleNumber" content="000007388"/><meta name="description" content="360008602431"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> PowerShell script created to break SFAM TSV Files into multiple server based on column name for host</p><p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> <span><span> In certain situations (misconfigurations or the defect mentioned here), it's possible for the activity from multiple hosts to be written to the same SAM log file. While there is a column in the file to represent the host name, the FSAC scan relies entirely on the name of the file and ignores this column. As a result, if FSAC is run against these files, activity may be reported as having occurred on the wrong server.</span></span><br/><br/><span><span>Updating to the latest version of SFAM\SFAM agent will resolve this issue moving forward but it won't fix the existing files. If we've already run FSAC against these files, this will not remove the activity from the database.  There may be instances where the customer stopped the scan after observing the error or would like to pull the information into the right server.  This script has been created to split the log file into separate logs that are named and filtered according to the value found in the Host column within the file.</span></span><br/> </p><p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> <span><span>Copy Activity TSV files to temp location</span></span><br/><br/><span><span>Update the PowerShell scripts with these variables based on your customer's environment</span></span><br/><br/><span><span><span><span><span><span><span>$logfilepath</span></span></span><span><span> <span>#folder path where log file is located</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$logfilename</span></span></span><span><span> <span>#actual log file name to process</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$outputfolder</span></span></span><span><span> <span>#location where split log files are</span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>#Run PowerShell Script Below </span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>#Dissects log file and makes smaller log files</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>#Script takes value from column in target log file</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>#makes new file with name of the value in the selected column</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>#puts all lines that match that value in chosen </span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>#column in perspective new log file</span></span></span></span></span></span></span><br/><br/><br/><span><span><span><span><span><span><span>#configuration</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$logfilepath</span></span></span><span><span> <span>=</span> <span>"C:\desktop\Split file on separator"</span> <span>#folder path where log file is located</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$logfilename</span></span></span><span><span> <span>=</span> <span>"SBSLAB-AUDIT_Log_20190527.tsv"</span> <span>#actual log file name to process</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$logfileextension</span></span></span><span><span> <span>=</span> <span>$logfilename</span><span>.</span>substring(<span>$logfilename</span><span>.</span>IndexOf(<span>"_"</span>)<span>,</span> <span>$logfilename</span><span>.</span>length <span>-</span> <span>$logfilename</span><span>.</span>IndexOf(<span>"_"</span>)) <span>#separates the date part of the file name</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$outputfolder</span></span></span><span><span> <span>=</span> <span>"C:\desktop\Split file on separator\output"</span> <span>#location where split log files are</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$delimiter</span></span></span><span><span> <span>=</span> <span>"`t"</span> <span>#delimiter between fields in log file</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$fieldnumber</span></span></span><span><span> <span>=</span> <span>"1"</span> <span>#first field is 0; field obviously needs valid file system character. Change this to 5 for folder name used to separate files by subfolders</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$hasheader</span></span></span><span><span> <span>=</span> <span>$false</span> <span>#value is true or false if the file contains a header row</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$statusupdate</span></span></span><span><span> <span>=</span> <span>100000</span> <span>#update every x number of lines processed</span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>#reset values for script execution</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$filename</span></span></span><span><span> <span>=</span> <span>""</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$outdata</span></span></span><span><span> <span>=</span> <span>""</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$line</span></span></span><span><span> <span>=</span> <span>""</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$linecounter</span></span></span><span><span> <span>=</span> <span>0</span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>$logfile</span></span></span><span><span> <span>=</span> <span>"</span><span>$logfilepath</span><span>\</span><span>$logfilename</span><span>"</span></span></span></span></span></span></span><br/><span><span><span><span><span><span><span>$starttime</span></span></span><span><span> <span>=</span> <span>get-date</span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>$logfilecontents</span></span></span><span><span> <span>=</span> <span>New-Object</span> <span>-TypeName</span> <span>System.IO.StreamReader</span> <span>-ArgumentList</span> <span>$logfile</span></span></span></span></span></span></span><br/><span><span><span><span> </span></span></span></span><br/><span><span><span><span><span><span><span>while</span></span></span><span><span> (<span>$line</span> <span>=</span> <span>$logfilecontents</span><span>.</span>ReadLine()){    </span></span></span></span></span></span><br/><br/><span><span><span><span><span><span>    <span>$temp</span> <span>=</span> <span>"</span>$((<span>$line</span> <span>-split</span> <span>$delimiter</span>)<span>[</span>(<span>$fieldnumber</span>)<span>]</span>)<span>"</span> </span></span></span></span></span></span><br/><span><span><span><span><span><span><span># this can be used to separate files by subfolder instead (which was used before Isilon Access Zones were supported in SAM): $temp = "$(($temp -split "\\")[2])"</span></span></span></span></span></span></span><br/><br/><br/><span><span><span><span><span><span>    <span>$filename</span> <span>=</span> <span>"</span><span>$temp</span><span>"</span> <span>+</span> <span>"</span><span>$logfileextension</span><span>"</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>    <span>$filepath</span> <span>=</span> <span>"</span><span>$outputfolder</span><span>\</span><span>$filename</span><span>"</span></span></span></span></span></span></span><br/><br/><span><span><span><span><span><span>    <span>if</span> (<span>$linecounter</span> <span>-eq</span> <span>0</span> <span>-and</span> <span>$hasheader</span>){</span></span></span></span></span></span><br/><span><span><span><span><span><span>        <span>$header</span> <span>=</span> <span>$line</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>    }</span></span></span></span></span></span><br/><span><span><span><span><span><span>    <span>else</span>{</span></span></span></span></span></span><br/><br/><span><span><span><span><span><span>        <span>if</span> (<span>-not</span> <span>$filearray</span> <span>-contains</span> <span>$filepath</span>){</span></span></span></span></span></span><br/><span><span><span><span><span><span>            <span>$filearray</span> <span>+=</span> <span>$filepath</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>            <span>if</span> (<span>$hasheader</span>){</span></span></span></span></span></span><br/><span><span><span><span><span><span>                <span>add-content</span> <span>$filepath</span> <span>$header</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>            }</span></span></span></span></span></span><br/><span><span><span><span><span><span>        }</span></span></span></span></span></span><br/><span><span><span><span><span><span>        <span>Add-Content</span> <span>$filepath</span> <span>$line</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>    }</span></span></span></span></span></span><br/><span><span><span><span>   </span></span></span></span><br/><span><span><span><span><span><span>    <span>$linecounter</span><span>++</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>    <span>if</span> (<span>$linecounter</span> <span>%</span> <span>$statusupdate</span> <span>-eq</span> <span>0</span>){</span></span></span></span></span></span><br/><span><span><span><span><span><span>        <span>$CurrentTime</span> <span>=</span> <span>get-date</span></span></span></span></span></span></span><br/><span><span><span><span><span><span>        <span>$runduration</span> <span>=</span> (<span>$currenttime</span> <span>-</span> <span>$starttime</span>)<span>.</span>seconds</span></span></span></span></span></span><br/><span><span><span><span><span><span>        <span>write-host</span> <span>"Lines Processed: </span><span>$linecounter</span><span>, RunTime: </span><span>$RunDuration</span><span> Seconds"</span></span></span></span></span></span></span><br/><span><span><span><span>       </span></span></span></span><br/><span><span><span><span><span><span>    } </span></span></span></span></span></span><br/><br/><span><span><span><span><span><span>}</span></span></span></span></span></span><br/><br/><span><span><span><span><span><span><span>write-host</span></span></span><span><span> <span>"Lines Processed: </span><span>$linecounter</span><span>, RunTime: </span><span>$RunDuration</span><span> Seconds"</span></span></span></span></span></span></span><br/><br/><br/><br/><span><span>Note: Because this script contains write-host, we cannot put it directly into the PowerShell DC without further modification. Additional changes and testing may be required for that use case.</span></span></p><p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> STEALTHbits File Activity Monitor<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - EMC/Celerra;File Activity Monitor - NetApp;File Activity Monitor - Windows<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> 2.2, 2.3, 2.4, 2.5<br/><strong><span class="wysiwyg-font-size-large">Dev Ticket:</span></strong> SFAM-3333<br/><strong><span class="wysiwyg-font-size-large">Resolved In:</span></strong> 2.5<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2397<br/></p></div>
</article></body></html>