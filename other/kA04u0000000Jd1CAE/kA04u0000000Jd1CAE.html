<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Mongo Commands - Report Cleanup Queries</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000Jd1CAE"/><meta name="Id" content="ka04u000000HdAZAA0"/><meta name="LastPublishedDate" content="2022-02-07T00:59:56.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:18:01.000+0000"/><meta name="FirstPublishedDate" content="2022-02-07T00:59:56.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="8299"/><meta name="ArticleNumber" content="000008299"/><meta name="description" content="HELPDESK"/></head><body><article class=" kb-articles"><div class="Content__c"><p>Best to use on any Change Tracker system that has been collecting data for a long time. These queries will remove old report data which is no longer used and which has possibly become fragmented within the collections.</p><p><strong>Step 1. To remove old report-run results from the R2 ReportData collection, leaving the scheduled report definitions in place:</strong> </p><ol><li>a) check what's there:</li></ol><p>&gt; db.ReportData.count({ _t : {$ne: "MongoScheduledReportItem"}} ); </p><ol><li>b) remove the data:</li></ol><p>&gt; db.ReportData.remove( { _t : {$ne: "MongoScheduledReportItem"}} );</p><p><br/></p><p><strong>Step 2. To remove old (pre-R2) saved query results</strong></p><ol><li><strong>a) check what's there (NB these queries have date ranges in case we need to keep recent results in some situations. The defaults used here delete all old saved query data from 2010 onwards)</strong></li></ol><p>&gt; db.SavedUserData.count({ _t: "MongoUserQueryResults", CreationDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") }, ExternalDataFileId : { $ne: null } });</p><p>&gt; db.fs.files.count({ "metadata.sourceQueryId" : { $exists:1}, uploadDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") }}); </p><ol><li><strong>b) remove the data</strong></li></ol><p>&gt; db.SavedUserData.remove({ _t: "MongoUserQueryResults", CreationDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") }, ExternalDataFileId : { $ne: null } });</p><p>&gt; db.fs.files.remove({ "metadata.sourceQueryId" : { $exists:1}, uploadDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") }});</p><p><strong>Step 2b. If you want to get rid of the smaller ones too use:</strong></p><p><strong>to check:</strong></p><p>&gt; db.SavedUserData.count({ _t: "MongoUserQueryResults", CreationDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") } });</p><p><br/></p><p><strong>to delete:</strong></p><p>&gt; db.SavedUserData.remove({ _t: "MongoUserQueryResults", CreationDate : { $gte : ISODate("2010-01-01T00:00:00.000Z"), $lte : ISODate("2030-01-01T00:00:00.000Z") } });</p><p><br/></p><p>// Optimising Queries for CT – This is Optional but may improve performance</p><p>// ====================================================================================================================</p><p><br/></p><p>use NNTHubService</p><p><br/></p><p>// Remove All Report results from Agent</p><p>db.SystemDirectory.update({ OrganizationId: 0, _t: "MongoAgentMember" }, { $pull : { "Agent.AgentPolicyResults" : { } } }, { multi: true } );</p><p><br/></p><p>// Find all Agents in Diagnostic Mode</p><p>db.SystemDirectory.find({_t: 'MongoAgentMember','Agent.DiagnosticModeEnabled': true}).count()</p><p><br/></p><p>// Unset all Agents in Diagnostic Mode</p><p>db.SystemDirectory.update({_t: 'MongoAgentMember','Agent.DiagnosticModeEnabled': true}, { $set: { 'Agent.DiagnosticModeEnabled': false } }, { multi: true })</p><p><br/></p><p>// Find any Planned Changes in Recording mode</p><p>db.PlannedChangeInstances.find({'InRecordingMode': true}).count()</p><p><br/></p><p>// Update any Planned Changes in Recording mode</p><p>db.PlannedChangeInstances.update({'InRecordingMode': true}, { $set: {'InRecordingMode': false} }, { multi: true })</p></div>
</article></body></html>