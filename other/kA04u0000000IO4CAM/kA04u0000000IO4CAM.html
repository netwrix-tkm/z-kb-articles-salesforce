<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Repair Non dbo Schema</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IO4CAM"/><meta name="Id" content="ka04u000000HclsAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:18:32.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:06:17.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:18:32.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="6504"/><meta name="ArticleNumber" content="000006504"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> how to repair non dbo schema</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> If a user doesn't have a default schema of dbo, SQL (2008+?) will automatically use a schema based on the username.<br/><br/>so, where a table in StealthAUDIT should be <br/>dbo.SA_MyJob_Table <br/><br/>it gets created as <br/>MyUserName.SA_MyJob_Table <br/><br/>Therefore, each user will have a separate set of tables and it can get confusing as to what the problem is pretty quickly.</p>
<p>Newer Versions of StealthAUDIT will prevent you from opening the console if you have the incorrect schema.</p>
<p>You can use the following script to move the tables from one schema to another. <br/><br/>If the table exists in the dbo schema already, too, you'll have to decide to either drop one or combine them by renaming one, moving schema, then running an insert, if applicable.</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> DECLARE cursore CURSOR FOR <br/><br/>select specific_schema as 'schema', specific_name AS 'name'<br/>FROM INFORMATION_SCHEMA.routines r1<br/>WHERE specific_schema AND NOT EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.Routines r2<br/>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = 'dbo')<br/>    <br/>UNION ALL<br/><br/>SELECT TABLE_SCHEMA AS 'schema', TABLE_NAME AS 'name'<br/>FROM INFORMATION_SCHEMA.TABLES t1<br/>WHERE TABLE_SCHEMA AND NOT EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.TABLES t2<br/>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = 'dbo')<br/><br/>DECLARE @schema sysname, <br/> @tab sysname, <br/> @sql varchar(500) <br/><br/>OPEN cursore     <br/>FETCH NEXT FROM cursore INTO @schema, @tab <br/><br/>WHILE @@FETCH_STATUS = 0     <br/>BEGIN <br/> SET @sql = 'ALTER SCHEMA dbo TRANSFER [' + @schema + '].[' + @tab +']'    <br/> PRINT @sql   <br/> exec (@sql)  <br/> FETCH NEXT FROM cursore INTO @schema, @tab     <br/>END <br/><br/>CLOSE cursore     <br/>DEALLOCATE cursore<br/><br/><span>--FROM HERE DOWN WILL DROP ALL TABLES, VIEWS, FUNCTIONS, PROCEDURES THAT ARE NOT DBO SCHEMA<br/>--So, if you intend on moving some, make sure the above script did what you want before running the rest </span><br/><br/>GO<br/><br/>-- drop tables ---<br/><br/>DECLARE cursore CURSOR FOR <br/><br/>SELECT TABLE_SCHEMA AS 'schema', TABLE_NAME AS 'name'<br/>FROM INFORMATION_SCHEMA.TABLES t1<br/>WHERE TABLE_SCHEMA AND TABLE_TYPE='BASE TABLE'<br/>AND EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.TABLES t2<br/>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = 'dbo' AND t2.TABLE_TYPE = 'BASE TABLE')<br/><br/>DECLARE @schema sysname, <br/> @tab sysname, <br/> @sql varchar(500) <br/><br/>OPEN cursore     <br/>FETCH NEXT FROM cursore INTO @schema, @tab <br/><br/>WHILE @@FETCH_STATUS = 0     <br/>BEGIN <br/> SET @sql = 'drop table ['+ @schema + '].[' + @tab +']'<br/> PRINT @sql   <br/> exec (@sql)  <br/> FETCH NEXT FROM cursore INTO @schema, @tab     <br/>END <br/><br/>CLOSE cursore     <br/>DEALLOCATE cursore<br/><br/>GO<br/><br/>-- drop views ---<br/><br/>DECLARE cursore CURSOR FOR <br/><br/>SELECT TABLE_SCHEMA AS 'schema', TABLE_NAME AS 'name'<br/>FROM INFORMATION_SCHEMA.TABLES t1<br/>WHERE TABLE_SCHEMA AND TABLE_TYPE='VIEW'<br/>AND EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.TABLES t2<br/>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = 'dbo' AND t2.TABLE_TYPE = 'VIEW')<br/><br/>DECLARE @schema sysname, <br/> @tab sysname, <br/> @sql varchar(500) <br/><br/>OPEN cursore     <br/>FETCH NEXT FROM cursore INTO @schema, @tab <br/><br/>WHILE @@FETCH_STATUS = 0     <br/>BEGIN <br/> SET @sql = 'drop view ['+ @schema + '].[' + @tab +']'<br/> PRINT @sql   <br/> exec (@sql)  <br/> FETCH NEXT FROM cursore INTO @schema, @tab     <br/>END <br/><br/>CLOSE cursore     <br/>DEALLOCATE cursore<br/><br/>GO<br/><br/>--drop functions-----------------------<br/><br/>DECLARE cursore CURSOR FOR <br/><br/>select specific_schema as 'schema', specific_name AS 'name'<br/>FROM INFORMATION_SCHEMA.routines r1<br/>WHERE specific_schema AND EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.Routines r2<br/>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = 'dbo' AND r2.ROUTINE_TYPE = 'FUNCTION')<br/>AND r1.ROUTINE_TYPE = 'FUNCTION'<br/><br/>DECLARE @schema sysname, <br/> @tab sysname, <br/> @sql varchar(500) <br/><br/>OPEN cursore     <br/>FETCH NEXT FROM cursore INTO @schema, @tab <br/><br/>WHILE @@FETCH_STATUS = 0     <br/>BEGIN <br/> SET @sql = 'drop function ['+ @schema + '].[' + @tab +']'<br/> PRINT @sql   <br/> exec (@sql)  <br/> FETCH NEXT FROM cursore INTO @schema, @tab     <br/>END <br/><br/>CLOSE cursore     <br/>DEALLOCATE cursore<br/><br/>GO</p>
<p>--drop procedures-----------------------<br/><br/>DECLARE cursore CURSOR FOR <br/><br/>select specific_schema as 'schema', specific_name AS 'name'<br/>FROM INFORMATION_SCHEMA.routines r1<br/>WHERE specific_schema AND r1.ROUTINE_TYPE = 'PROCEDURE'<br/>AND EXISTS( --no equivalent object exists with dbo schema<br/>    SELECT NULL<br/>    FROM INFORMATION_SCHEMA.Routines r2<br/>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = 'dbo' AND r2.ROUTINE_TYPE = 'PROCEDURE')<br/><br/>DECLARE @schema sysname, <br/> @tab sysname, <br/> @sql varchar(500) <br/><br/>OPEN cursore     <br/>FETCH NEXT FROM cursore INTO @schema, @tab <br/><br/>WHILE @@FETCH_STATUS = 0     <br/>BEGIN <br/> SET @sql = 'drop procedure ['+ @schema + '].[' + @tab +']'<br/> PRINT @sql   <br/> exec (@sql)  <br/> FETCH NEXT FROM cursore INTO @schema, @tab     <br/>END <br/><br/>CLOSE cursore     <br/>DEALLOCATE cursore<br/><br/>/*<br/><br/>create table guest.SA_Tbl (blah varchar(50))<br/>go<br/>create view guest.SA_View as (select * from guest.SA_Tbl)<br/><br/>*/</p>
<p><strong><span class="wysiwyg-font-size-large">Module:</span></strong> Database/SQL<br/><strong><span class="wysiwyg-font-size-large">Dev Ticket:</span></strong> 6930<br/><strong><span class="wysiwyg-font-size-large">Salesforce Article ID:</span></strong> 000001173</p></div>
</article></body></html>