<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Bulk Correction of HubService Log: Error, requested Agent name is in use</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000JY7CAM"/><meta name="Id" content="ka04u000000Hd9OAAS"/><meta name="LastPublishedDate" content="2022-02-07T00:58:25.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:17:35.000+0000"/><meta name="FirstPublishedDate" content="2022-02-07T00:58:25.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="8288"/><meta name="ArticleNumber" content="000008288"/><meta name="description" content="HELPDESK"/></head><body><article class=" kb-articles"><div class="Content__c"><p>Usually caused by machines that have been reimaged but maintain their original hostname. The reimage has caused the agent.id file to be regenerated and therefore the agent is attempting to register with a different agent id that is held within the Change Tracker database.</p><p>The error logged within the Hubservice log for this type of situation will look like this:</p><p> 2019-01-14 12:15:42,378 [1049] ERROR NNT.Hub.Service.Utilities.ErrorHandler - 'Error, requested Agent name is in use by device with uniqueId: 9c9bbda9-db50-42b4-81ff-d25de6f8183e' for device at ip: 1.1.1.1 (Error code: 882fbf59-6587-4eab-bcde-e865473b6c04) Request={"CanProxy":true,"DeviceName":"ServerName","DeviceType":"Unknown","GroupNames":[],"HostType":"Unknown","IPv4":"1.1.1.1","OnlineDetection":"None","Os":"Windows 7 Enterprise","Registered":false,"UniqueId":"3e74ab97a1804ab0aa1792d6c20cd221","Version":700010055}</p><p><br/></p><p>If you have a significant number of these errors, indicating that many systems have been reimaged and are now unable to register with Change Tracker, then this process can be used to bulk reset the agent ids within the Mongo database and so allow agents to once again register.</p><p><br/></p><p>Here are the steps to take when converting a hubservice-log.txt file with errors like this :</p><p>2019-01-11 12:43:22,647 [138] ERROR NNT.Hub.Service.Utilities.ErrorHandler - 'Error, requested Agent name is in use by device with uniqueId: 2a2c921a-c1b3-432c-8c79-242ffed5ce03' for device at ip: 172.30.11.28 (Error code: 956d9615-9f3a-4d6f-90f1-55f87084c08c)</p><p>to a series of Mongo “update” statements that will reset the UniqueId property in the database allowing the agent to send in a new Id :</p><p>db.SystemDirectory.update({ "Agent.UniqueId" : new BinData(3, "EmcwAaIzf02M2Yn3oZQsuA==") },{ $unset : { "Agent.UniqueId" : 1 }}, { multi:false });</p><p><br/></p><p><strong>You will need some kind of Linux / bash shell to run this and also the “jq” command (used in step 2) to parse the JSON response (<a class="external-link" href="https://stedolan.github.io/jq/" target="_blank">https://stedolan.github.io/jq/</a>)</strong></p><p><strong>On a CentOS system # yum install jq can be used to install the required JSON processor.</strong></p><p><br/></p><p>1) Extract a unique list of unique ids :</p><p><strong>cat hubservice-log.txt | grep "requested Agent name is in use by device with uniqueId" | awk -F":" ' { print $4 }' | sed -e 's/^[[:space:]]*//' | grep -v -e '^$' | awk -F"'" ' { print $1 }' | sort -u &gt; guids.txt</strong></p><p>This will parse the hubservice-log.txt file and extract a unique list of ids in the file “guids.txt”</p><p>2) Convert the text guids to binary form : </p><p><strong>cat guids.txt | xargs -I GUID curl -s -d 'guid=GUID' <a class="external-link" href="http://guid-convert.appspot.com/query" target="_blank">http://guid-convert.appspot.com/query</a> | jq '.b64' &gt; bindata.txt</strong></p><p>This uses the external site to convert the ids, one at a time, to their base64-encoded binary representation.  Depending on the number of ids this may take a moment.</p><p>3) Apply the ids to the update statement :</p><p><strong>cat bindata.txt | awk ' { printf "db.SystemDirectory.update({ \"Agent.UniqueId\" : new BinData(3, %s) },{ $unset : { \"Agent.UniqueId\" : 1 }}, { multi:false });\n",$1 }' &gt; jdw.js</strong></p><p>This slots each id into the update statement and puts it in the output file “jdw.js”</p><p><br/></p><p>Once the creation of the js file is complete, move it to the server running the Mongo db and run the following command.</p><p><strong>mongo.exe 127.0.0.1/NNTHubService C:\jdw.js</strong></p><p>If the Mongo database is configured with a username and password then run the following command using the admin details.</p><p><strong>mongo.exe 127.0.0.1/NNTHubService D:\jdw.js -u admin -p password --authenticationDatabase admin</strong></p><p><strong>If you want to check the process, use the this Mongo command to show the details of an agent including the Uniqueld that is being altered.</strong></p><p><strong>db.SystemDirectory.find({ "_t" : "MongoAgentMember", "Name" : "1,1" }).pretty();</strong></p><p>{<br/>"_id" : "5c334054a6603208c42be18c",<br/>"_t" : [<br/>"MongoMember",<br/>"MongoAgentMember"<br/>],<br/>"Name" : "1,1",<br/>"DisplayName" : "WIN-I4SM26EE0R3",<br/>"OrganizationId" : 0,<br/>"MemberOf" : [<br/>"All Devices",<br/>"Windows 2012 R2"<br/>],<br/>"LastActivityTimeUtc" : ISODate("2019-01-14T16:12:03.407Z"),<br/>"PlannedChangeInstanceStatuses" : {</p><p>},<br/>"Credentials" : [ ],<br/>"Agent" : {<br/>"ModelVersion" : 700010045,<br/>"AgentDevice" : {<br/>"AgentId" : "1",<br/>"DeviceId" : "1"<br/>},<br/>"Version" : "7.0.0.35",<br/>"Name" : "WIN-I4SM26EE0R3",<br/>"DeviceName" : "WIN-I4SM26EE0R3",<br/>"DeviceType" : 0,<br/>"HostType" : 2,<br/>"Os" : "Windows Server 2012 R2 Standard",<br/>"KnownOsName" : null,<br/>"OsVariant" : null,<br/>"Registered" : true,<br/>"Deleted" : false,<br/>"PollPeriodSeconds" : 30,<br/>"LegacyId" : null,<br/>"HostName" : null,<br/>"IPv4" : "172.31.34.202",<br/>"IPv6" : "fe80::b5d4:fce7:665f:38d1%12",<br/>"LastPollUtc" : ISODate("2019-01-15T10:56:32.860Z"),<br/>"NextPollUtc" : ISODate("2019-01-15T10:57:12.860Z"),<br/>"MembershipChangeTimeUtc" : null,<br/>"OnlineStatus" : 2,<br/>"DiagnosticModeEnabled" : false,<br/>"OnlineDetection" : 0,<br/>"PingTimeoutSeconds" : 15,<br/>"TcpConnectPort" : 0,<br/>"CanProxy" : true,<br/>"<u><strong>UniqueId" : BinData(3,"7dRKqMkDskmeyAhl2Hr2CQ=="),</strong></u><br/>"AgentPolicyResults" : [</p><p><br/></p></div>
</article></body></html>