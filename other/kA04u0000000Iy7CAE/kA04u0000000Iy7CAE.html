<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Test Network Port</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000Iy7CAE"/><meta name="Id" content="ka04u000000HczUAAS"/><meta name="LastPublishedDate" content="2022-02-01T18:44:44.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:12:57.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:44:44.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7377"/><meta name="ArticleNumber" content="000007377"/><meta name="description" content="360008816812"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Troubleshooting firewall issues with PowerShell</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> <span>Before deploying Stealthbits</span><span>'</span><span> products</span><span>,</span><span> there are a number of firewall ports required to open.  Using Windows PowerShell to create a Function</span><span>,</span><span> we can initiate a port listener and verify that there is proper connectivity between servers and clients (e.g., Proxy and StealthAUDIT), or if firewalls are blocking those ports. </span><br/><strong><em><span>Before running any PowerShell scripts we need to make sure they are not blocked by the Execution Policy.</span></em></strong><br/><br/><strong><span><span><span>On the server (the computer where the port needs to be open)</span></span></span></strong><br/><br/><span><span><span>1) Paste the below script into a PowerShell or PowerShell ISE session running as administrator on the server.</span></span></span></p>
<ol><li><strong><em><span><span><span>ALTERNATIVELY, copy below PowerShell script into a text file and Save it with extension .ps1, zip it and send it to customer</span></span></span></em></strong></li><li><strong><em><span><span><span>Open PowerShell on Windows server you want the port to listen on</span></span></span></em></strong></li><li>
<strong><em><span><span><span>Make sure the Execution Policy will not block the script by use of cmdlet "powershell -ExecutionPolicy Bypass"</span></span></span></em></strong> <strong><em><span><span><span>(this will only be effective in this PowerShell session)</span></span></span></em></strong>
</li></ol>
<p><strong><em><span><span><span>OR</span></span></span></em></strong></p>
<ol><li><strong><em><span>Use cmdlet "Get-ExecutionPolicy" to get the original setting.  Then use cmdlet  "Set-ExecutionPolicy Unrestricted -Force" and make sure to set it back to original setting after helping customer. </span></em></strong></li><li><strong><em><span><span><span>Run the PowerShell script created</span></span></span></em></strong></li></ol>
<p> <br/><strong><em><span>-Note: Changing the Execution Policy allows you to send the PowerShell script to the customer as a ps1 file via zip file, easy for the customer to download and for you to execute it </span></em></strong><strong><em><span>by calling it from PowerShell allowing an easier transition. Instead of you sending them the whole script string on email or GTM chat and then pasting it, where it </span></em></strong><strong><em><span>may raise concern to see a bunch of code.</span></em></strong><br/> <br/> <br/> <br/> <br/><span><span><span/></span><br/><span><span><span>Copyright (C) 2018 STEALTHBITS TECHNOLOGIES, INC.</span></span></span><br/><span><span><span>Written by:  Ricky Calder</span></span></span><br/><span><span><span>Date:        2018/05/25</span></span></span><br/> <br/><span><span><span>.DESCRIPTION</span></span></span><br/><span><span><span>Assist in troubleshooting firewall issues. Creates a listener on selected port.</span></span></span><br/> <br/><span><span><span>.PARAMETER Port</span></span></span><br/><span><span><span>The TCP port that the listener should attach to</span></span></span><br/> <br/><span><span><span>#&gt;</span></span></span><br/><span><span><span>function</span></span></span> <span><span><span>STEALTHTest-Port</span></span></span><span><span><span>{</span></span></span><br/><span><span><span># Define Parameter</span></span></span><br/><span><span><span>Param</span></span></span><span><span><span> (</span></span></span><br/>  <span><span><span>[</span></span></span><span><span><span>Parameter</span></span></span><span><span><span>(Mandatory</span></span></span><span><span><span>=</span></span></span><span><span><span>$True</span></span></span><span><span><span>,</span></span></span><span><span><span>Position</span></span></span><span><span><span>=</span></span></span><span><span><span>0</span></span></span><span><span><span>,</span></span></span><span><span><span>HelpMessage</span></span></span><span><span><span>=</span></span></span><span><span><span>"Specify Port to listen on"</span></span></span><span><span><span>)</span></span></span><span><span><span>]</span></span></span><br/>  <span><span><span>[</span></span></span><span><span><span>string</span></span></span><span><span><span>]</span></span></span><span><span><span>$Port</span></span></span><span><span><span>,</span></span></span><br/> <br/>  <span><span><span>[</span></span></span><span><span><span>Parameter</span></span></span><span><span><span>(Mandatory</span></span></span><span><span><span>=</span></span></span><span><span><span>$True</span></span></span><span><span><span>,</span></span></span><span><span><span>Position</span></span></span><span><span><span>=</span></span></span><span><span><span>2</span></span></span><span><span><span>,</span></span></span><span><span><span>HelpMessage</span></span></span><span><span><span>=</span></span></span><span><span><span>"Log file location"</span></span></span><span><span><span>)</span></span></span><span><span><span>]</span></span></span><br/>   <span><span><span>[</span></span></span><span><span><span>ValidateScript</span></span></span><span><span><span>({</span></span></span><br/>        <span><span><span>If</span></span></span><span><span><span>(</span></span></span><span><span><span>Test-Path</span></span></span> <span><span><span>$_</span></span></span><span><span><span>){</span></span></span><span><span><span>$true</span></span></span><span><span><span>}</span></span></span><span><span><span>else</span></span></span><span><span><span>{</span></span></span><span><span><span>Throw</span></span></span> <span><span><span>"Invalid path given: </span></span></span><span><span><span>$_</span></span></span><span><span><span>"</span></span></span><span><span><span>}</span></span></span><br/><span><span><span>        })</span></span></span><span><span><span>]</span></span></span><br/>  <span><span><span>[</span></span></span><span><span><span>string</span></span></span><span><span><span>]</span></span></span><span><span><span>$LogFilePath</span></span></span><br/><span><span><span>)</span></span></span><br/> <br/><span><span><span># Create Log function</span></span></span><br/> <br/><span><span><span>$Logfile</span></span></span> <span><span><span>=</span></span></span> <span><span><span>$LogFilePath</span></span></span> <span><span><span>+</span></span></span><span><span><span>'\'</span></span></span> <span><span><span>+</span></span></span><span><span><span> $(</span></span></span><span><span><span>Get-Date</span></span></span><span><span><span>)</span></span></span><span><span><span>.</span></span></span><span><span><span>tostring(</span></span></span><span><span><span>"ddMMyyyyHHmm"</span></span></span><span><span><span>)</span></span></span><span><span><span>+</span></span></span><span><span><span>'.log'</span></span></span><br/> <br/><span><span><span>Function</span></span></span> <span><span><span>LogWrite</span></span></span><br/><span><span><span>{</span></span></span><br/>   <span><span><span>Param</span></span></span><span><span><span> (</span></span></span><span><span><span>[</span></span></span><span><span><span>string</span></span></span><span><span><span>]</span></span></span><span><span><span>$logstring</span></span></span><span><span><span>)</span></span></span><br/>   <span><span><span>$logstring</span></span></span><span><span><span>=</span></span></span><span><span><span>$(</span></span></span><span><span><span>get-date</span></span></span> <span><span><span>-Format</span></span></span> <span><span><span>"yyyy-MM-dd HH:mm:ss"</span></span></span><span><span><span>)</span></span></span><span><span><span>+</span></span></span><span><span><span>"`t"</span></span></span><span><span><span>+</span></span></span><span><span><span>$LogString</span></span></span><br/>   <span><span><span>Add-content</span></span></span> <span><span><span>$Logfile</span></span></span> <span><span><span>-value</span></span></span> <span><span><span>$LogString</span></span></span> <br/><span><span><span>}</span></span></span><br/> <br/><span><span><span># Port Listener </span></span></span><br/> <br/>    <span><span><span>$endpoint</span></span></span> <span><span><span>=</span></span></span> <span><span><span>new-object</span></span></span> <span><span><span>System.Net.IPEndPoint</span></span></span><span><span><span> (</span></span></span><span><span><span>[</span></span></span><span><span><span>system.net.ipaddress</span></span></span><span><span><span>]::</span></span></span><span><span><span>any</span></span></span><span><span><span>,</span></span></span> <span><span><span>$port</span></span></span><span><span><span>)    </span></span></span><br/>    <span><span><span>$listener</span></span></span> <span><span><span>=</span></span></span> <span><span><span>new-object</span></span></span> <span><span><span>System.Net.Sockets.TcpListener</span></span></span> <span><span><span>$endpoint</span></span></span><br/>    <span><span><span>$listener</span></span></span><span><span><span>.</span></span></span><span><span><span>server</span></span></span><span><span><span>.</span></span></span><span><span><span>ReceiveTimeout </span></span></span><span><span><span>=</span></span></span> <span><span><span>5000</span></span></span><br/>    <span><span><span>$listener</span></span></span><span><span><span>.</span></span></span><span><span><span>start()    </span></span></span><br/>    <span><span><span>try</span></span></span><span><span><span> {</span></span></span><br/>    <span><span><span>$Logstring</span></span></span> <span><span><span>=</span></span></span> <span><span><span>"Listening on port </span></span></span><span><span><span>$port</span></span></span><span><span><span>"</span></span></span><br/>    <span><span><span>Logwrite</span></span></span> <span><span><span>$Logstring</span></span></span><br/>    <span><span><span>While</span></span></span><span><span><span> (</span></span></span><span><span><span>$true</span></span></span><span><span><span>){</span></span></span><br/>        <span><span><span>if</span></span></span><span><span><span> (</span></span></span><span><span><span>!</span></span></span><span><span><span>$listener</span></span></span><span><span><span>.</span></span></span><span><span><span>Pending())</span></span></span><br/><span><span><span>        {</span></span></span><br/>            <span><span><span>Start-Sleep</span></span></span> <span><span><span>-Seconds</span></span></span> <span><span><span>1</span></span></span><span><span><span>; </span></span></span><br/>            <span><span><span>continue</span></span></span><span><span><span>; </span></span></span><br/><span><span><span>        }</span></span></span><br/>       <span><span><span>$client</span></span></span> <span><span><span>=</span></span></span> <span><span><span>$listener</span></span></span><span><span><span>.</span></span></span><span><span><span>AcceptTcpClient()</span></span></span><br/>       <span><span><span>$Logstring</span></span></span> <span><span><span>=</span></span></span> <span><span><span>"Client IP Address "</span></span></span> <span><span><span>+</span></span></span> <span><span><span>$client</span></span></span><span><span><span>.</span></span></span><span><span><span>client</span></span></span><span><span><span>.</span></span></span><span><span><span>RemoteEndPoint </span></span></span><span><span><span>+</span></span></span> <span><span><span>" Successfully Connected"</span></span></span><br/>       <span><span><span>logwrite</span></span></span> <span><span><span>$Logstring</span></span></span><br/>       <span><span><span>$client</span></span></span><span><span><span>.</span></span></span><span><span><span>close()</span></span></span><br/>    <br/><span><span><span>        }</span></span></span><br/><span><span><span>    }</span></span></span><br/>    <span><span><span>catch</span></span></span><span><span><span> {</span></span></span><br/>       <span><span><span>$logstring</span></span></span> <span><span><span>=</span></span></span> <span><span><span>Write-Error</span></span></span> <span><span><span>$_</span></span></span>     <br/>       <span><span><span>logwrite</span></span></span> <span><span><span>$Logstring</span></span></span>     <br/><span><span><span>    }</span></span></span><br/>    <span><span><span>finally</span></span></span><span><span><span>{</span></span></span><br/>            <span><span><span>$listener</span></span></span><span><span><span>.</span></span></span><span><span><span>stop()</span></span></span><br/>            <span><span><span>$Logstring</span></span></span> <span><span><span>=</span></span></span> <span><span><span>"Listener Closed Safely"</span></span></span><br/>            <span><span><span>logwrite</span></span></span> <span><span><span>$logstring</span></span></span> <br/><span><span><span>    }</span></span></span><br/> <br/><span><span><span>}</span></span></span></span></p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> <span><span><span>2) Ensure that no other applications are running on the server by running netstat on the server and searching for the port to be tested.</span></span></span><br/><span><span><span>C:\Windows\system32&gt; netstat -a -o</span></span></span><br/><span><span><span> <br/>You should NOT see the port in the list if it's not in use by another program. If you do, look at the PID specified in the results table and correlate to a process in task manager. You may have to stop services or close programs to clear.</span></span></span><br/> <br/> <br/><span><span>3) Execute the PowerShell to create the functions. After executing the PowerShell, the </span></span><span><span><span>STEALTHTest-Port </span></span></span><span><span>function will be available. This command has two parameters, </span></span><span><span><span>Port</span></span></span><span><span> and </span></span><span><span><span>LogfilePath</span></span></span><span><span>. </span></span></p>
<ol><li><span><span><span>The Port is the port on the server with which the client will try to communicate.</span></span></span></li><li><span><span><span>The log file path must be a string that points to a folder that already exists. A log will be created with details on connection (e.g., client IP address if it connects successfully).</span></span></span></li></ol>
<p> <br/><span><span><span>STEALTHTest-Port</span></span></span> <span><span><span>-Port</span></span></span> <span><span><span>8766</span></span></span> <span><span><span>-LogFilePath</span></span></span> <span><span><span>C:\Temp </span></span></span><br/><span><span><span>STEALTHTest-Port</span></span></span> <span><span><span>8766</span></span></span> <span><span><span>"C:\Temp Folder"</span></span></span><br/> <br/><span><span><span>Note: When testing is complete, use "Ctrl + C" to stop the listener.<br/> <br/> <br/> </span></span></span><br/><strong><span><span><span>On the client (the computer where the connection is initiated)</span></span></span></strong><br/><span><span><span>Run the following command in PowerShell or PowerShell ISE</span></span></span><br/><span><span><span>If the port is closed or the host is invalid (or some other issue), an error will be thrown in the client.  </span></span></span><br/><span><span><span>New-Object</span></span></span> <span><span><span>System.Net.Sockets.TcpClient</span></span></span><span><span><span>(</span></span></span><span><span><span>"ComputerNameOrIPAddress"</span></span></span><span><span><span>,</span></span></span> <span><span><span>8766</span></span></span><span><span><span>) </span></span></span><br/><br/> <br/><span><span><span>Port Closed:</span></span></span><br/><span><span><span>PS C:\Windows\system32&gt; New-Object System.Net.Sockets.TcpClient("SBTESTSERVER01", 8766) | fl *</span></span></span><br/><span><span><span>New-Object : Exception calling ".ctor" with "2" argument(s): "No connection could be made because the target machine actively refused it 192.168.15.152:8766"</span></span></span><br/><span><span><span>At line:1 char:1</span></span></span><br/><span><span><span>+ New-Object System.Net.Sockets.TcpClient("SBTESTSERVER01", 8766) | fl *</span></span></span><br/><span><span><span>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span></span><br/><span><span><span>    + CategoryInfo          : InvalidOperation: (:) [New-Object], MethodInvocationException</span></span></span><br/><span><span><span>    + FullyQualifiedErrorId : ConstructorInvokedThrowException,Microsoft.PowerShell.Commands.NewObjectCommand </span></span></span><br/> <br/><span><span><span>Invalid Host Name</span></span></span><br/><span><span><span>PS C:\Windows\system32&gt; New-Object System.Net.Sockets.TcpClient("SBTESTSERVER02", 8766) | fl *</span></span></span><br/><span><span><span>New-Object : Exception calling ".ctor" with "2" argument(s): "No such host is known"</span></span></span><br/><span><span><span>At line:1 char:1</span></span></span><br/><span><span><span>+ New-Object System.Net.Sockets.TcpClient("SBTESTSERVER02", 8766) | fl *</span></span></span><br/><span><span><span>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span></span><br/><span><span><span>    + CategoryInfo          : InvalidOperation: (:) [New-Object], MethodInvocationException</span></span></span><br/><span><span><span>    + FullyQualifiedErrorId : ConstructorInvokedThrowException,Microsoft.PowerShell.Commands.NewObjectCommand</span></span></span><br/><span><span><span> <br/><br/>The full list of Windows Socket Error Codes is available on MSDN - </span></span></span><span><span><span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms740668(v=vs.85).aspx" target="_blank"><span>https://msdn.microsoft.com/en-us/library/windows/desktop/ms740668(v=vs.85).aspx</span></a></span></span></span><br/><span><span><span> <br/>If the port is opening and the port is listening, connection information should be returned:</span></span></span><br/><span><span><span>NoDelay             : False </span></span></span><br/><span><span><span>LingerState         : System.Net.Sockets.LingerOption</span></span></span><br/><span><span><span>SendTimeout         : 0</span></span></span><br/><span><span><span>ReceiveTimeout      : 0</span></span></span><br/><span><span><span>SendBufferSize      : 65536</span></span></span><br/><span><span><span>ReceiveBufferSize   : 65536</span></span></span><br/><span><span><span>ExclusiveAddressUse : False</span></span></span><br/><span><span><span>Connected           : True</span></span></span><br/><span><span><span>Available           : 0</span></span></span><br/><span><span><span>Client              : System.Net.Sockets.Socket</span></span></span><br/><span><span><span> <br/> </span></span></span><br/><span><span><span>S C:\Windows\system32&gt; New-Object System.Net.Sockets.TcpClient("SBTESTSERVER01", 8766)</span></span></span><br/> </p>
<p><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 1992</p></div>
</article></body></html>