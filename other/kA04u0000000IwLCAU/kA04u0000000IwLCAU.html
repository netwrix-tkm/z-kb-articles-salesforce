<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>SQL Function to Extract OU Name from DN</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IwLCAU"/><meta name="Id" content="ka04u000000HcyoAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:43:12.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:12:40.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:43:12.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7345"/><meta name="ArticleNumber" content="000007345"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Description and code to create a reusable function in SQL to easily extract Organizational Unit Name from the DistinguishedName</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> <span>Quite often we have the need for reporting purposes to identify the Organization Unit from the Users DistinguishedName. This is currently not available in the OOB reports.</span></p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> <span><span><strong>:</strong>  By creating the below function we are easily able to extract OU from DN in a simple process of passing the DN value as a parameter for the SQL Function to process, simplifying your SQL code.</span></span><br/><span><span>The code utilizes several inbuilt sql functions which are listed out below.  </span></span></p>
<p> </p>
<p><span><span>1. PatIndex</span></span></p>
<p>2. <span><span>Charindex</span></span></p>
<p>3. <span>Substring</span></p>
<p><span><span> </span></span><br/><strong><span class="wysiwyg-underline"><span><span>Setup a SteathAUDIT Job with Analysis</span></span></span></strong></p>
<p><span><span>Create a new analysis using the SQLScripting analysis module. </span></span></p>
<p><span><span>Name this Analysis something that is easily identifiable for example "SQL Function creation". </span></span></p>
<p><span><span> Give it a description including the name of the function being created; in this instance it should be </span></span></p>
<p><span><span><span>[</span></span></span><span><span><span>dbo].[SA_ENG_GetOUFromDN]</span></span></span><br/><span><span> </span></span><br/><span><span><span class="wysiwyg-underline"><strong>Create SQL script</strong></span>  </span></span></p>
<p><span><span>Click configure and add the below code. </span></span></p>
<p><span><span>Save and Exit</span></span><br/><span><span> </span></span><br/><span><span>Script:</span></span><br/><span><span><span>IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SA_ENG_GetOUFromDN]') AND type in (N'FN'))</span></span></span><br/><span><span><span>DROP FUNCTION [dbo].[SA_ENG_GetOUFromDN]</span></span></span><br/><span><span><span> </span></span></span><br/><span><span><span>GO</span></span></span><br/><span><span><span>;</span></span></span><br/><span><span><span>CREATE FUNCTION dbo.SA_ENG_GetOUFromDN (@DN nvarchar(450))</span></span></span><br/><span><span><span>  RETURNS nvarchar(450)</span></span></span><br/><span><span><span>AS</span></span></span><br/><span><span><span>BEGIN</span></span></span><br/><span><span><span>  DECLARE @IDX INT</span></span></span><br/><span><span><span>  DECLARE @RetVal NVARCHAR(450)</span></span></span><br/><span><span><span> </span></span></span><br/><span><span><span>  SET @IDX = PATINDEX('%OU=%', @DN)</span></span></span><br/><span><span><span>    SET @RetVal = CAST(@IDX AS nvarchar(450))</span></span></span><br/><span><span><span>  IF @IDX = 0</span></span></span><br/><span><span><span>  BEGIN</span></span></span><br/><span><span><span>    SET @RetVal = NULL</span></span></span><br/><span><span><span>  END</span></span></span><br/><span><span><span>  ELSE</span></span></span><br/><span><span><span>  BEGIN</span></span></span><br/><span><span><span>    SET @RetVal = SUBSTRING(@DN, @IDX+ 3, CHARINDEX(',', SUBSTRING(@DN, @IDX, LEN(@DN))) -4) </span></span></span><br/><span><span><span>  END</span></span></span><br/><span><span><span> </span></span></span><br/><span><span><span>  RETURN @RetVAL</span></span></span><br/><span><span><span>END</span></span></span><br/><span><span><span> </span></span></span><br/><span><span><span>GO</span></span></span><br/><span><span> </span></span><br/><span><span>Step three: Run the SQL analysis to create the function.</span></span><br/><span><span> </span></span><br/><span><span>How to Use the function:  Below is a simple query which will return the users OU as a column from the SA_ADInventory_UsersView</span></span><br/><span><span> </span></span><br/><span><span>Example: </span></span><br/><span><span> </span></span><br/><span><span><span><span><span>select</span></span></span><span><span> SamAccountName</span></span></span></span><br/><span><span><span><span><span>,</span></span></span><span><span> NTAccount</span></span></span></span><br/><span><span><span><span><span>,</span></span></span><span><span> [dbo]<span>.</span>[SA_ENG_GetOUFromDN]<span>(</span>DistinguishedName<span>)</span> <span>as</span> OU</span></span></span></span><br/><span><span><span><span><span>,</span></span></span><span><span> DistinguishedName</span></span></span></span><br/><span><span><span><span> </span></span></span></span><br/><span><span><span><span><span>From</span></span></span><span><span> SA_ADInventory_usersView</span></span></span></span><br/><span><span> </span></span><br/><span><span>Output:</span></span><br/><span><span> </span></span><br/><span><span>SamAccountName          NTAccount                                       OU                                       DistinguishedName</span></span><br/><span><span>ADM_Admin                     DOMAIN\ADM_Admin                  PrivilegedUsers                CN=ADM_ Admin,OU=PrivilegedUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br/><span><span>M136694                           DOMAIN\M136694                        StandardUsers                  CN=Test User 5,OU=StandardUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br/><span><span>M136695                           DOMAIN\M136695                        StandardUsers                  CN=Test User 6,OU=StandardUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br/><span><span> </span></span><br/><span><span>Explanation on example:</span></span><br/><span><span>Note that the function is included in the select Statement followed by an Alias of "OU" this is so when the job is run and inserted into table it will have a column header which is a requirement for select INTO.</span></span><br/><span><span>We pass the column name DistinguishedName from the SA_ADInventory_UsersView table to the function which pulls out the first OU=</span></span><br/> </p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - Core<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> 7.2+<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2422</p></div>
</article></body></html>