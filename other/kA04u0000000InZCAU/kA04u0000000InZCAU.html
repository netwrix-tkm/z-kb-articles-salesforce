<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Filtering SDD matches with additional validation</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000InZCAU"/><meta name="Id" content="ka04u000000HcvxAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:44:23.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:11:15.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:44:23.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7367"/><meta name="ArticleNumber" content="000007367"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Sometimes regexes/patterns are not enough to validate sensitive data matches and additional validation/filtering is required</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Describes a method to validate sensitive data against checksums/algorithms that are not available in the standard product.</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong>  <br/><strong><span>Summary</span></strong><br/><span>.</span>        <strong>Sensitive data discovery includes Luhn and Mod 11 validation as standard, but it is sometimes necessary to apply alternative validation approaches. This KB article describes the implementation of code to perform such a validation and accurately update the match tables by removing data that fails the validation.</strong><br/><strong><span>Scope</span></strong><br/><span>.</span>        <strong>This applies to all versions of StealthAUDIT </strong><br/><strong>(Has been tested v8.1)</strong><br/> <br/><strong><span>Details</span></strong><br/><span>.</span>        <strong>The validation is implemented in two parts, a function to determine if a data item passes validation, and a processing script to apply this function to collected data and delete data that does not pass validation. </strong><br/> <br/><span>.</span>        <strong>An example of such function code is:</strong><br/> <br/><span><span><span>IF</span></span></span><span><span> <span>OBJECT_ID</span><span>(</span><span>'SA_PS_DoesPatternMatch'</span><span>,</span> <span>'FN'</span><span>)</span> <span>IS</span> <span>NOT</span> <span>NULL</span></span></span><br/><span><span>                                          <span>DROP</span> <span>FUNCTION</span> dbo<span>.</span>SA_PS_DoesPatternMatch</span></span><br/><span><span><span>GO</span></span></span><br/> <br/><span><span><span>CREATE</span></span></span><span><span> <span>FUNCTION</span> dbo<span>.</span>SA_PS_DoesPatternMatch<span>(</span>@Pattern <span>varchar</span><span>(</span>15<span>))</span></span></span><br/><span><span><span>RETURNS</span></span></span><span><span> <span>INT</span></span></span><br/><span><span><span>AS</span></span></span><br/><span><span><span>BEGIN</span></span></span><br/><span><span><span>DECLARE</span></span></span><span><span> @RetVal <span>INT</span></span></span><br/><span><span>      <span>DECLARE</span> @K <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @L <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @M <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @N <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @O <span>INT</span></span></span><br/><span><span>      <span>DECLARE</span> @P <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @Q <span>INT</span></span></span><br/><span><span>      <span>DECLARE</span> @R <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @S <span>INT</span> </span></span><br/><span><span>      <span>DECLARE</span> @T <span>INT</span> </span></span><br/>     <br/><span><span>      <span>IF</span> @Pattern <span>IS</span> <span>NULL</span> <span>-- Check not blank</span></span></span><br/><span><span>            <span>RETURN</span> <span>-</span>1</span></span><br/>           <br/><span><span>      <span>IF</span> <span>LEN</span><span>(</span>@Pattern<span>)</span> <span>!=</span> 15 <span>-- Check right length</span></span></span><br/><span><span>            <span>RETURN</span> <span>-</span>2</span></span><br/>           <br/><span><span>      <span>IF</span> @Pattern <span>NOT</span> <span>LIKE</span> <span>'IDCZE[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span> <span>-- Check format</span></span></span><br/><span><span>            <span>RETURN</span> <span>-</span>3</span></span><br/> <br/><span><span>      <span>SET</span> @K <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>, </span>6<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @L <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>, </span>7<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span> </span></span><br/><span><span>      <span>SET</span> @M <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>, </span>8<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @N <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>, </span>9<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @O <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 10<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @P <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 11<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @Q <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 12<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @R <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 13<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @S <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 14<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/><span><span>      <span>SET</span> @T <span>=</span> <span>CAST</span><span>(</span><span>SUBSTRING</span><span>(</span>@Pattern<span>,</span> 15<span>,</span>1<span>)</span> <span>AS</span> <span>INT</span><span>)</span></span></span><br/>     <br/><span><span>      <span>IF</span> @T <span>!=</span> <span>(</span>@K<span>*</span>7 <span>+</span> @L<span>*</span>3 <span>+</span> @M<span>*</span>1 <span>+</span> @N<span>*</span>7 <span>+</span> @O<span>*</span>3 <span>+</span> @P<span>*</span>1 <span>+</span> @Q<span>*</span>7 <span>+</span> @R<span>*</span>3 <span>+</span> @S<span>*</span>1<span>)</span> <span>%</span> 10 <span>-- Check checksum</span></span></span><br/><span><span>            <span>RETURN</span> <span>-</span>4</span></span><br/>     <br/><span><span>      <span>RETURN</span> 1 </span></span><br/><span><span><span>END</span></span></span><br/> <br/><span><span><span>GO</span></span></span><br/> <span>                                                                                                                                    .</span><span><span>                                                            </span></span><strong>Example code which then uses the function to delete false matches. Note this updates the matches table so that match counts still correspond to the number of related rows in the match hits table.</strong><br/><span><span><span>declare</span></span></span><span><span> @CriteriaName <span>varchar</span><span>(</span>64<span>)</span> <span>=</span> <span>'IDC'</span></span></span><br/> <br/><span><span><span>-- Delete invalid hit records for the criteria</span></span></span><br/><span><span><span>DELETE</span></span></span><span><span> mh</span></span><br/><span><span><span>FROM</span></span></span><span><span>  dbo<span>.</span>SA_FSDLP_Criteria c</span></span><br/><span><span><span>INNER</span></span></span><span><span> <span>JOIN</span> dbo<span>.</span>SA_FSDLP_MatchHits mh</span></span><br/><span><span>      <span>ON</span> mh<span>.</span>HOST <span>=</span> c<span>.</span>HOST <span>AND</span> mh<span>.</span>CriteriaId <span>=</span> c<span>.</span>ID</span></span><br/><span><span><span>WHERE</span></span></span><span><span> c<span>.</span>Name <span>=</span> @CriteriaName</span></span><br/><span><span><span>AND</span></span></span><span><span> dbo<span>.</span>SA_PS_DoesPatternMatch<span>(</span>matchdata<span>)</span> <span>!=</span> 1</span></span><br/> <br/><span><span><span>-- Delete match records that no longer have hit records for the criteria (every hit for this host/criteria failed validation)</span></span></span><br/><span><span><span>DELETE</span></span></span><span><span> M</span></span><br/><span><span><span>FROM</span></span></span><span><span>  dbo<span>.</span>SA_FSDLP_Criteria c</span></span><br/><span><span><span>INNER</span></span></span><span><span> <span>JOIN</span> dbo<span>.</span>SA_FSDLP_Matches m</span></span><br/><span><span><span>ON</span></span></span><span><span> m<span>.</span>HOST <span>=</span> c<span>.</span>HOST </span></span><br/><span><span><span>AND</span></span></span><span><span> m<span>.</span>CriteriaId <span>=</span> c<span>.</span>ID</span></span><br/><span><span><span>WHERE</span></span></span><span><span> c<span>.</span>Name <span>=</span> @CriteriaName <span>AND</span> <span>NOT</span> <span>EXISTS</span> <span>(</span><span>SELECT</span> <span>'x'</span></span></span><br/><span><span><span>FROM</span></span></span><span><span> dbo<span>.</span>SA_FSDLP_MatchHits mh</span></span><br/><span><span><span>WHERE</span></span></span><span><span> mh<span>.</span>HOST <span>=</span> c<span>.</span>HOST <span>AND</span> mh<span>.</span>CriteriaId <span>=</span> c<span>.</span>ID <span>AND</span> mh<span>.</span>FileId <span>=</span> m<span>.</span>FileId<span>)</span></span></span><br/> <br/><span><span>      <span>-- Update match count records for the criteria</span></span></span><br/><span><span><span>UPDATE</span></span></span><span><span> M</span></span><br/><span><span><span>SET</span></span></span><span><span> Matchcount <span>=</span> <span>(</span></span></span><br/><span><span><span>SELECT</span></span></span><span><span> <span>COUNT</span><span>(*)</span></span></span><br/><span><span><span>FROM</span></span></span><span><span> dbo<span>.</span>SA_FSDLP_MatchHits mh</span></span><br/><span><span><span>WHERE</span></span></span><span><span> mh<span>.</span>HOST <span>=</span> c<span>.</span>HOST <span>AND</span> mh<span>.</span>CriteriaId <span>=</span> c<span>.</span>ID <span>AND</span> mh<span>.</span>FileId <span>=</span> m<span>.</span>FileId<span>)</span></span></span><br/><span><span><span>FROM</span></span></span><span><span>  dbo<span>.</span>SA_FSDLP_Criteria c</span></span><br/><span><span><span>INNER</span></span></span><span><span> <span>JOIN</span> dbo<span>.</span>SA_FSDLP_Matches m</span></span><br/><span><span><span>ON</span></span></span><span><span> m<span>.</span>HOST <span>=</span> c<span>.</span>HOST <span>AND</span> m<span>.</span>CriteriaId <span>=</span> c<span>.</span>ID</span></span><br/><span><span><span>WHERE</span></span></span><span><span> c<span>.</span>Name <span>=</span> @CriteriaName</span></span><br/>  <br/><strong><span>Implementation Notes</span></strong><br/><span>.</span>        <strong>The example code is for File sensitive data, but should be easily adapted for SharePoint/Exchange/SQL.</strong><br/> <br/> </p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - DC - FSAA - Sensitive Data;SA - DC - SPAA - Sensitive Data;SA - Solution Set - File System;SA - Solution Set - SharePoint<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 1884</p></div>
</article></body></html>