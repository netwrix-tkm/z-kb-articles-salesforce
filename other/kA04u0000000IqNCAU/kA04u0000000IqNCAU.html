<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>How to find a specific object or objects with specific attributes across multiple databases</title><meta name="label" content="skb"/><meta name="label" content="employees_v"/><meta name="KnowledgeArticleId" content="kA04u0000000IqNCAU"/><meta name="Id" content="ka04u000000HcwwAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:34:18.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:11:58.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:34:18.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7215"/><meta name="ArticleNumber" content="000007215"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Use of stored procedures as an alternative to cursor creation</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> When trying execute the same command on multiple databases the creation of cursors can make the task longer than needed and using the stored procedure "sp_msforeachdb" can help making the script shorter.</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong>  <br/><span><span><span>sp_msforeachdb </span></span></span><span><span><span>is a stored procedure that iterates through all the databases in a SQL instance and executes the same command, which is passed to the stored procedure as a string parameter. This is similar to the exec or sp_execute procedures, but executed as many times as there are databases in the instance</span></span></span><span><span><span>. </span></span></span><span><span><span>That been said lets analyze the script step by step:</span></span></span><br/> </p>
<ul><li><span><span>'?' is a variable that is replaced with the name of the database in the iterator.</span></span></li><li><span><span>The first command in the string parameter is 'use'; You need it to establish a session to each database and '?' is a variable that is replaced with the name of the database in the iterator.</span></span></li><li><span><span>The '?' is inside [] to delimit identifiers (object names). This is necessary if the object name is a reserved keyword or contains special characters such as hyphen or space.</span></span></li></ul>
<p> <br/><span><span><span>Example 1:</span></span></span><br/> <br/><span><span><span>This script is checking if a specific table is present in each of the databases that the stored procedure sp_msforeachdb.</span></span></span><br/><span><span><span>This command 'use [?]...' is run with the purpose of finding out which database has executed a rollback of an action module in a file system by looking for an object ending in 'fsactionsrollback'</span></span></span><br/><span><span><span>This script is useful because it makes the script shorter and easier to read as opposed to creating a cursor to iterate through each database</span></span></span><br/> <br/><span><span><span>sp_msforeachdb 'use [?]</span></span></span><br/><span><span><span>if exists (select null from sys.objects where name like ''%fsactionsrollback'')</span></span></span><br/><span><span><span>select ''?'' as DB, name, type_desc from sys.objects where name like ''%fsactionsrollback'''</span></span></span><br/>  </p>
<ul><li><span><span>The first line of the above script is iterating through each database and opening a session with the database that the variable '?' is holding by use of the keyword 'use'</span></span></li><li>
<span><span>The second line is using a conditional that will evaluate the existence of an object ending in </span></span><span><span><span>'fsactionsrollback' </span></span></span><span><span>in the database that is currently in use (which ever database name the variable '?' is holding)</span></span>
</li><li>
<span><span>If the previous condition is true then the select statement in the third line of the script will proceed and columns will be selected from the </span></span><span><span><span>sys.objects </span></span></span><span><span>view.</span></span>
</li><li>
<span><span>This select statement also creates a column named </span></span><span><span><span>'DB' </span></span></span><span><span>to display the name of the current database that </span></span><span><span><span>sp_msforeachdb </span></span></span><span><span>is iterating through. Because the whole point of this script is to tell us if that object exists and in which database.</span></span>
</li><li>
<span><span><span>Please note the use of escape characters on the second line for </span></span></span><span><span>''%fsactionsrollback'' </span></span><span><span><span>and in the third line </span></span></span><span><span>''?''</span></span><span><span><span>.  Without the escape characters the quotation marks would mean the end of the command given to the store procedure to execute.</span></span></span> </li></ul>
<p> <span><span><span>Example 2:</span></span></span><br/> <br/><span><span><span>This script is searching for any columns that contain a data type 'text' in all the databases that sp_msforeachdb is iterating through and displays the results found by database.</span></span></span><br/><span><span><span>This command is run with the purpose of identifying in which database the data type text is located to change it for the data type vachar(MAX). This is done because after SQL Server 2005 the text type will not be supported by Microsoft anymore.</span></span></span><br/><span><span><span>This script is useful because it makes the script shorter and easier to read as opposed to creating a cursor to iterate through each database.</span></span></span><br/> <br/><span><span><span>sp_msforeachdb 'use [?] </span></span></span><br/><span><span><span>if exists (select null from information_schema.columns where data_type=''text'')</span></span></span><br/><span><span><span>select distinct ''?'' as DB, table_name, column_name from information_schema.columns where data_type=''text'''</span></span></span><br/><br/></p>
<ul><li><span><span>The first line of the above script is iterating through each database and opening a session with the database that the variable '?' is holding by use of the keyword 'use'</span></span></li><li>
<span><span>The second line is using a conditional that will evaluate the existence of at least one column that contains the data type 'text' in the database that is currently in use (which ever database name the variable '?' is holding) by searching in the </span></span><span><span><span>information_schema.columns </span></span></span><span><span>view.</span></span>
</li><li>
<span><span>If the previous condition is true then the select statement in the third line of the script will proceed and columns will be selected from the </span></span><span><span><span>information_schema.columns view</span></span></span>
</li><li>
<span><span>This select statement also creates a column named </span></span><span><span><span>'DB' </span></span></span><span><span>to display the name of the current database that </span></span><span><span><span>sp_msforeachdb </span></span></span><span><span>is iterating through. Because the whole point of this script is to tell us in which database that column exists.</span></span>
</li><li>
<span><span><span>Please note the use of escape characters on the second line for </span></span></span><span><span>''text'' </span></span><span><span><span>and in the third line </span></span></span><span><span>''?''</span></span><span><span><span>.  Without the escape characters, the quotation marks would mean the end of the command given to the stored procedure to execute.</span></span></span> </li></ul>
<p>Note:     <strong><em>-There is also a stored procedure for table iteration in case you need it "sp_msforeachtable"</em></strong><br/><strong><em>                -These two stored procedures(sp_msforeachdb and sp_msforeachtable) are not supported by Microsoft and should only be used for troubleshooting.  Reason being that it may skip some databases while iterating or even break completely.</em></strong><br/><strong><em>                -These stored procedures will only work in MSSQL</em></strong><br/> </p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - Windows;SA - Core;SI - Admin Console<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2159</p></div>
</article></body></html>