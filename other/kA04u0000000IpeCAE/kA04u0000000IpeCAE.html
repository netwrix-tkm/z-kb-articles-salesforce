<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Test remote process creation</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IpeCAE"/><meta name="Id" content="ka04u000000HcwdAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:32:49.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:11:48.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:32:49.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7186"/><meta name="ArticleNumber" content="000007186"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Uses WMI to spawn a notepad.exe process on a remote machine. This can be useful for troubleshooting applet or agent deployment from StealthAUDIT, StealthINTERCEPT, or STEALTHbits Activity Monitor (SAM), since it requires the same privileges, ports, etc., but results in demonstrably negligible load to the target device.</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Receive Access Denied, Insufficient Privilege, Path not found, Invalid Parameter, or other error message when trying to start a process (e.g., SmartLOG applet, agent installer)</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> The following script emulates the behavior of the product when it attempts to launch a process remotely using WMI. It will not fix the issue, but it does help to show that an issue is related to permissions or privileges, rather than the product.<br/> <br/> <br/><span><span><span/></span><br/><span><span><span>    STEALTHbits Technologies, Inc.</span></span></span><br/><span><span><span>    Kyle Enman</span></span></span><br/><span><span><span>    2018/10/04</span></span></span><br/><span><span><span>    Uses WMI to spawn a notepad.exe process on a remote machine.</span></span></span><br/><span><span><span>    Useful for troubleshooting applet or agent deployment from StealthAUDIT, StealthINTERCEPT, or STEALTHbits Activity Monitor (SAM), since it requires the same privileges, ports, etc., but results in demonstrably negligible load to the target device.</span></span></span><br/><span><span><span>#&gt;</span></span></span><br/> <br/><span><span><span>#gets credentials for testing</span></span></span><br/><span><span><span>if</span></span></span><span><span> (<span>$cred</span> <span>-eq</span> <span>$null</span>){<span>$cred</span> <span>=</span> <span>get-credential</span>}</span></span><br/> <br/> <br/><span><span><span>if</span></span></span><span><span>(<span>$Results</span> <span>-ne</span> <span>$null</span>){<span>Remove-Variable</span> <span>Results</span>}</span></span><br/><span><span><span>if</span></span></span><span><span>(<span>$TermResults</span> <span>-ne</span> <span>$null</span>){<span>Remove-Variable</span> <span>TermResults</span>}</span></span><br/> <br/> <br/><span><span><span>#input target Windows server</span></span></span><br/><span><span><span>$compName</span></span></span><span><span><span>=read-host </span></span></span><span><span><span>'Enter Server Name'</span></span></span><br/> <br/><span><span><span>#instantiate process and create it on the target server</span></span></span><br/><span><span><span>$process</span></span></span><span><span> <span>=</span> <span>get-wmiobject</span> <span>-query</span> <span>"SELECT * FROM Meta_Class WHERE __Class = 'Win32_Process'"</span> <span>-namespace</span> <span>"root\cimv2"</span> <span>-computername</span> <span>$CompName</span> <span>-credential</span> <span>$cred</span> <span>-ErrorAction</span> <span>SilentlyContinue</span></span></span><br/><span><span><span>if</span></span></span><span><span>(<span>$process</span> <span>-eq</span> <span>$null</span>){</span></span><br/><span><span>    <span>$Error</span><span>[</span><span>0</span><span>].</span>Exception}</span></span><br/><span><span><span>else</span></span></span><span><span>{</span></span><br/><span><span>    <span>$results</span> <span>=</span> <span>$process</span><span>.</span>Create( <span>"notepad.exe"</span> )</span></span><br/><span><span>    <span>If</span>(<span>$results</span><span>.</span>ReturnValue <span>-eq</span> <span>0</span>){</span></span><br/><span><span>        <span>write-host</span> <span>"Process Creation: Success"</span>}</span></span><br/><span><span>    <span>else</span>{</span></span><br/><span><span>        <span>"Process Creation: Failed - return code: </span>$(<span>$results</span><span>.</span>ReturnValue)<span>"</span>}</span></span><br/> <br/><span><span>    <span>#output results (commented by default)</span></span></span><br/><span><span>    <span>#$results</span></span></span><br/> <br/> <br/><span><span>    <span>#Terminates process</span></span></span><br/><span><span>    <span>if</span>(<span>$results</span><span>.</span>ReturnValue <span>-eq</span> <span>0</span>){</span></span><br/><span><span>        <span>$TermResults</span> <span>=</span> (<span>gwmi</span> <span>win32_process</span> <span>-ComputerName</span> <span>$CompName</span> <span>-filter</span> <span>"processID=</span>$(<span>$results</span><span>.</span>ProcessID)<span>"</span> <span>-cred</span> <span>$cred</span>)<span>.</span>terminate()</span></span><br/><span><span>        <span>If</span>(<span>$TermResults</span><span>.</span>ReturnValue <span>-eq</span> <span>0</span>){<span>write-host</span> <span>"Process Termination: Success"</span>} <span>else</span>{<span>"Process Termination: Failed - return code: </span>$(<span>$results</span><span>.</span>ReturnValue)<span>"</span>}</span></span><br/><span><span>    }</span></span><br/> <br/><span><span>    <span>#output results (commented by default)</span></span></span><br/><span><span>    <span>#$TermResults</span></span></span><br/><span><span>}</span></span><br/> <br/><span><span><span>https://docs.microsoft.com/en-us/windows/desktop/cimwin32prov/create-method-in-class-win32-process</span></span></span><br/> <br/><span><span><span>Successful completion (0)</span></span></span><br/><span><span><span>Access denied (2)</span></span></span><br/><span><span><span>Insufficient privilege (3)</span></span></span><br/><span><span><span>Unknown failure (8)</span></span></span><br/><span><span><span>Path not found (9)</span></span></span><br/><span><span><span>Invalid parameter (21)</span></span></span><br/><span><span><span>Other (22 4294967295)</span></span></span><br/> <br/><span><span><span>Other HRESULT errors, system error codes: <a href="https://docs.microsoft.com/en-us/windows/desktop/Debug/system-error-codes" target="_blank">https://docs.microsoft.com/en-us/windows/desktop/Debug/system-error-codes</a></span></span></span><br/><span><span><span>Note: Access Denied may result from bad password. RPC Server unavailable may result from a bad user ID</span></span></span><br/> <br/><span><span><span>#&gt;</span></span></span><br/> <br/>If "Success" is returned, then the process was created without issue. Otherwise, review the ReturnValue (return code) of the function (which will likely match the error thrown within the product) for additional ideas on how to resolve.<br/> <br/>If "Success" is returned, but the same results are not mirrored when using the product, then there is likely either a product issue (bug), or some other factor specific to our software (e.g., Bit9, antivirus lockdown).<br/> <br/> </span></p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - Windows;SA - Core;SI - Windows Agent<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> All<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2107</p></div>
</article></body></html>