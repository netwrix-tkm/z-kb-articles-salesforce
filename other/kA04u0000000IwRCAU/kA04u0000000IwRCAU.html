<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Enabling Compression for FSAA tables in SQL Standard Edition when Available</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IwRCAU"/><meta name="Id" content="ka04u000000HcyrAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:44:54.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:12:40.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:44:54.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7383"/><meta name="ArticleNumber" content="000007383"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Shows how to alter the appropriate tables to include compression, and how to edit the "0-Create Schema" job's #CreateWithCompression procedure to work on SQL Server 2016 SP1 Standard Edition and above.</p><p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Deploying SQL Enterprise Edition is expensive, but we typically recommend it for activity monitoring and sensitive data use cases are in scope because of the data compression feature (<a href="https://docs.microsoft.com/en-us/sql/relational-databases/data-compression/data-compression?view=sql-server-2017" target="_blank">https://docs.microsoft.com/en-us/sql/relational-databases/data-compression/data-compression?view=sql-server-2017</a>). However, starting with SQL 2016 SP1, compression became available in non-enterprise editions, like standard and express. As a result, we're able to direct customers to Standard edition, which presents a significant cost savings in terms of Total Cost of Ownership (TCO) compared to Enterprise Edition. However, we do not enable compression unless the database is enterprise edition.<br/><br/>The following rows may be added to the standard "1. Create Tables" analysis task in the "0-Create Schema" job in the File System Solution Set.<br/> <br/><span><span><span>CREATE</span></span></span> <span><span><span>PROCEDURE</span></span></span><span><span><span> #CreateWithCompression</span></span></span><br/><span><span><span>  @CompressionType </span></span></span><span><span><span>nvarchar</span></span></span><span><span><span>(</span></span></span><span><span><span>128</span></span></span><span><span><span>),</span></span></span><br/><span><span><span>  @CreateScript </span></span></span><span><span><span>nvarchar</span></span></span><span><span><span>(</span></span></span><span><span><span>max</span></span></span><span><span><span>)</span></span></span><br/><span><span><span>AS</span></span></span><br/>  <span><span><span>DECLARE</span></span></span><span><span><span> @cmd </span></span></span><span><span><span>nvarchar</span></span></span><span><span><span>(</span></span></span><span><span><span>max</span></span></span><span><span><span>);</span></span></span><br/>  <span><span><span>SET</span></span></span><span><span><span> @cmd </span></span></span><span><span><span>=</span></span></span><span><span><span> @CreateScript</span></span></span><span><span><span>;</span></span></span><br/>  <span><span><span>IF</span></span></span> <span><span><span>CAST</span></span></span><span><span><span>(</span></span></span><span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'edition'</span></span></span><span><span><span>)</span></span></span> <span><span><span>AS</span></span></span> <span><span><span>VARCHAR</span></span></span><span><span><span>(</span></span></span><span><span><span>32</span></span></span><span><span><span>))</span></span></span> <span><span><span>LIKE</span></span></span> <span><span><span>'Enterprise%'</span></span></span><br/>  <span><span><span><span>OR</span></span></span></span> <span><span><span><span>SERVERPROPERTY</span></span></span></span><span><span><span><span>(</span></span></span></span><span><span><span><span>'ProductMajorVersion'</span></span></span></span><span><span><span><span>)&gt;</span></span></span></span><span><span><span><span>13</span></span></span></span><br/>  <span><span><span><span>OR</span></span></span></span> <span><span><span><span>(</span></span></span></span><span><span><span><span>SERVERPROPERTY</span></span></span></span><span><span><span><span>(</span></span></span></span><span><span><span><span>'ProductMajorVersion'</span></span></span></span><span><span><span><span>)=</span></span></span></span><span><span><span><span>13 </span></span></span></span><span><span><span><span>AND</span></span></span></span> <span><span><span><span>CAST</span></span></span></span><span><span><span><span>(</span></span></span></span><span><span><span><span>SERVERPROPERTY</span></span></span></span><span><span><span><span>(</span></span></span></span><span><span><span><span>'ProductLevel'</span></span></span></span><span><span><span><span>)</span></span></span></span> <span><span><span><span>AS</span></span></span></span> <span><span><span><span>VARCHAR</span></span></span></span><span><span><span><span>(</span></span></span></span><span><span><span><span>5</span></span></span></span><span><span><span><span>))</span></span></span></span> <span><span><span><span>LIKE</span></span></span></span> <span><span><span><span>'SP%'</span></span></span></span><span><span><span><span>)</span></span></span></span><br/>    <span><span><span>SELECT</span></span></span><span><span><span> @cmd </span></span></span><span><span><span>=</span></span></span><span><span><span> @cmd </span></span></span><span><span><span>+</span></span></span> <span><span><span>N' WITH (DATA_COMPRESSION = '</span></span></span> <span><span><span>+</span></span></span><span><span><span> @CompressionType </span></span></span><span><span><span>+</span></span></span> <span><span><span>N')'</span></span></span><span><span><span>;</span></span></span><br/>  <span><span><span>EXECUTE</span></span></span> <span><span><span>sp_executesql</span></span></span> <span><span><span>@cmd</span></span></span><span><span><span>;</span></span></span><br/><span><span><span>GO</span></span></span><br/> </p><p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> If the tables have already been created, the following will add compression if it's possible to add by: 
</p><ol><li>checking if the SQL server supports compression
</li><li>checking if compression exists on the table already
</li><li> adds it on the appropriate tables if it's not already present</li></ol> <br/><span><span><span>IF </span></span></span><span><span><span>(</span></span></span><span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'EngineEdition'</span></span></span><span><span><span>)=</span></span></span><span><span><span>3  </span></span></span><span><span><span>--enterprise edition</span></span></span><br/><span><span><span>OR</span></span></span> <span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductMajorVersion'</span></span></span><span><span><span>)&gt;</span></span></span><span><span><span>13 </span></span></span><br/><span><span><span>OR</span></span></span> <span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductMajorVersion'</span></span></span><span><span><span>)=</span></span></span><span><span><span>13 </span></span></span><span><span><span>AND</span></span></span> <span><span><span>cast</span></span></span><span><span><span>(</span></span></span><span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductLevel'</span></span></span><span><span><span>)</span></span></span> <span><span><span>AS</span></span></span> <span><span><span>VARCHAR</span></span></span><span><span><span>(</span></span></span><span><span><span>5</span></span></span><span><span><span>))</span></span></span> <span><span><span>LIKE</span></span></span> <span><span><span>'SP%'</span></span></span><span><span><span>)</span></span></span><br/><span><span><span>and</span></span></span> <span><span><span>exists</span></span></span> <span><span><span>(</span></span></span><span><span><span>select</span></span></span> <span><span><span>null</span></span></span> <span><span><span>from</span></span></span> <span><span><span>sys</span></span></span><span><span><span>.</span></span></span><span><span><span>objects</span></span></span> <span><span><span>where</span></span></span> <span><span><span>name</span></span></span><span><span><span>=</span></span></span><span><span><span>'SA_FSAA_Resources'</span></span></span> <span><span><span>AND</span></span></span> <span><span><span>type</span></span></span><span><span><span>=</span></span></span><span><span><span>'u'</span></span></span><span><span><span>)</span></span></span> <span><span><span>--table exists</span></span></span><br/><span><span><span>and</span></span></span> <span><span><span>not</span></span></span> <span><span><span>exists</span></span></span> <span><span><span>(</span></span></span><span><span><span>select</span></span></span> <span><span><span>null</span></span></span> <span><span><span>from</span></span></span> <span><span><span>sys</span></span></span><span><span><span>.</span></span></span><span><span><span>partitions</span></span></span> <span><span><span>where</span></span></span> <span><span><span>object_ID</span></span></span><span><span><span>=</span></span></span><span><span><span>object_id</span></span></span><span><span><span>(</span></span></span><span><span><span>'SA_FSAA_Resources'</span></span></span><span><span><span>,</span></span></span><span><span><span>'u'</span></span></span><span><span><span>)</span></span></span> <span><span><span>and</span></span></span> <span><span><span>data_compression</span></span></span><span><span><span>&gt;</span></span></span><span><span><span>0</span></span></span><span><span><span>)</span></span></span> <span><span><span>--compression is not enabled</span></span></span><br/>       <span><span><span>ALTER</span></span></span> <span><span><span>TABLE</span></span></span><span><span><span> dbo</span></span></span><span><span><span>.</span></span></span><span><span><span>SA_FSAA_Resources </span></span></span><span><span><span>REBUILD</span></span></span> <span><span><span>PARTITION</span></span></span> <span><span><span>=</span></span></span> <span><span><span>ALL</span></span></span> <br/>       <span><span><span>WITH </span></span></span><span><span><span>(</span></span></span><span><span><span>DATA_COMPRESSION</span></span></span> <span><span><span>=</span></span></span> <span><span><span>ROW</span></span></span><span><span><span>);</span></span></span><br/><span><span><span>GO</span></span></span><br/> <br/><span><span><span>IF </span></span></span><span><span><span>(</span></span></span><span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'EngineEdition'</span></span></span><span><span><span>)=</span></span></span><span><span><span>3  </span></span></span><span><span><span>--enterprise edition</span></span></span><br/><span><span><span>OR</span></span></span> <span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductMajorVersion'</span></span></span><span><span><span>)&gt;</span></span></span><span><span><span>13 </span></span></span><br/><span><span><span>OR</span></span></span> <span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductMajorVersion'</span></span></span><span><span><span>)=</span></span></span><span><span><span>13 </span></span></span><span><span><span>AND</span></span></span> <span><span><span>cast</span></span></span><span><span><span>(</span></span></span><span><span><span>SERVERPROPERTY</span></span></span><span><span><span>(</span></span></span><span><span><span>'ProductLevel'</span></span></span><span><span><span>)</span></span></span> <span><span><span>AS</span></span></span> <span><span><span>VARCHAR</span></span></span><span><span><span>(</span></span></span><span><span><span>5</span></span></span><span><span><span>))</span></span></span> <span><span><span>LIKE</span></span></span> <span><span><span>'SP%'</span></span></span><span><span><span>)</span></span></span><br/><span><span><span>and</span></span></span> <span><span><span>exists</span></span></span> <span><span><span>(</span></span></span><span><span><span>select</span></span></span> <span><span><span>null</span></span></span> <span><span><span>from</span></span></span> <span><span><span>sys</span></span></span><span><span><span>.</span></span></span><span><span><span>objects</span></span></span> <span><span><span>where</span></span></span> <span><span><span>name</span></span></span><span><span><span>=</span></span></span><span><span><span>'SA_FSAA_Rights'</span></span></span> <span><span><span>AND</span></span></span> <span><span><span>type</span></span></span><span><span><span>=</span></span></span><span><span><span>'u'</span></span></span><span><span><span>)</span></span></span> <span><span><span>--table exists</span></span></span><br/><span><span><span>and</span></span></span> <span><span><span>not</span></span></span> <span><span><span>exists</span></span></span> <span><span><span>(</span></span></span><span><span><span>select</span></span></span> <span><span><span>null</span></span></span> <span><span><span>from</span></span></span> <span><span><span>sys</span></span></span><span><span><span>.</span></span></span><span><span><span>partitions</span></span></span> <span><span><span>where</span></span></span> <span><span><span>object_ID</span></span></span><span><span><span>=</span></span></span><span><span><span>object_id</span></span></span><span><span><span>(</span></span></span><span><span><span>'SA_FSAA_Rights'</span></span></span><span><span><span>,</span></span></span><span><span><span>'u'</span></span></span><span><span><span>)</span></span></span> <span><span><span>and</span></span></span> <span><span><span>data_compression</span></span></span><span><span><span>&gt;</span></span></span><span><span><span>0</span></span></span><span><span><span>)</span></span></span> <span><span><span>--compression is not enabled</span></span></span><br/> <br/>       <span><span><span>ALTER</span></span></span> <span><span><span>TABLE</span></span></span><span><span><span> dbo</span></span></span><span><span><span>.</span></span></span><span><span><span>SA_FSAA_Rights </span></span></span><span><span><span>REBUILD</span></span></span> <span><span><span>PARTITION</span></span></span> <span><span><span>=</span></span></span> <span><span><span>ALL</span></span></span> <br/>       <span><span><span>WITH </span></span></span><span><span><span>(</span></span></span><span><span><span>DATA_COMPRESSION</span></span></span> <span><span><span>=</span></span></span> <span><span><span>ROW</span></span></span><span><span><span>);</span></span></span><br/><span><span><span>GO</span></span></span><br/> <br/>Only the Rights and Resources tables should have any level of compression.<br/> <p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - DC - FSAA - Activity;SA - DC - FSAA - DFS;SA - DC - FSAA - Permissions<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> 8.0+<br/><strong><span class="wysiwyg-font-size-large">Dev Ticket:</span></strong> Escalation 27720 / SAFS-15477<br/><strong><span class="wysiwyg-font-size-large">Resolved In:</span></strong> Not addressed in product as of 8.2 CU Released 2019/03/29<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2306<br/></p></div>
</article></body></html>