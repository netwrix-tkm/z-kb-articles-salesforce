<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>Collecting Debug Info for StealthDEFEND Action Services</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000IPMCA2"/><meta name="Id" content="ka04u000000HcmRAAS"/><meta name="LastPublishedDate" content="2022-02-01T18:19:09.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:06:34.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:19:09.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="6529"/><meta name="ArticleNumber" content="000006529"/><meta name="description" content="360008304072"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Describes how to generate additional logs for investigation if the StealthDEFEND Action Service does not appear to be working correctly.</p>
<p><br/><span><span><strong>Issue:</strong>  Sometimes the Actions Log and information in the application GUI may not be detailed enough to capture the level of detail required to diagnose a failed job.</span></span></p>
<p><br/><span><span><strong><span>Instructions:</span></strong><span>  Create a playbook with a PowerShell Runtime. Use the below script. This will generate logs files containing </span></span></span></p>
<ol><li><span><span><span>The Threat Data (which caused the action to run)</span></span></span></li><li><span><span><span>The Event Data, and </span></span></span></li><li><span><span><span>The Hostname</span></span></span></li></ol>
<p><span><span><span>and store them in C:\ProgramData\STEALTHbits\StealthDEFEND.</span></span></span><br/><br/><span><span><span>Be sure to also collect the standard Action Service log file from [InstallPath]\ StealthDEFEND\ActionService\Log (C:\ProgramData\STEALTHbits\StealthDEFEND\ActionService\Log by default)<br/><br/>------ Start of shell -----</span></span></span><br/><span><span><span><span>$Threat</span></span> <span><span>=</span></span> <span><span>Get-SDThreat</span></span> <span><span>-id</span></span> <span><span>$ThreatId</span></span> <span><span>-RestApiUri</span></span> <span><span>$SDRestApiUri</span></span> <span><span>-RestApiToken</span></span> <span><span>$SDRestApiToken</span></span></span></span><br/><span><span><span><span>$Event</span></span> <span><span>=</span></span> <span><span>Get-SDEvent</span></span> <span><span>-Id</span></span> <span><span>$Threat</span></span><span><span>.</span></span><span><span>PrimaryEventId </span></span><span><span>-RestApiUri</span></span> <span><span>$SDRestApiUri</span></span> <span><span>-RestApiToken</span></span> <span><span>$SDRestApiToken</span></span></span></span><br/><br/><span><span><span><span>$HostName</span></span> <span><span>=</span></span> <span><span>Get-ShortSamAccountName</span></span> <span><span>-SamAccountName</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>SourceHost</span></span><span><span>.</span></span><span><span>Name</span></span></span></span><br/><br/><span><span><span><span>$Threat</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\threat.log"</span></span></span></span><br/><span><span><span><span>$Event</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\event.log"</span></span></span></span><br/><span><span><span><span>$HostName</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\hostname.log"</span></span></span></span><br/><br/><br/><span><span><span><span>if</span></span><span><span> (</span></span><span><span>$env:COMPUTERNAME</span></span> <span><span>-Like</span></span> <span><span>$HostName</span></span><span><span>) {</span></span></span></span><br/><span><span>    <span><span>Stop-Process</span></span> <span><span>-Name</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name</span></span><span><span>.</span></span><span><span>ToLower()</span></span><span><span>.</span></span><span><span>TrimEnd(</span></span><span><span>'.exe'</span></span><span><span>) </span></span><span><span>-Force</span></span></span></span><br/><span><span><span><span>} </span></span><span><span>else</span></span><span><span> {</span></span></span></span><br/><span><span>    <span><span>if</span></span><span><span> (</span></span><span><span>-not</span></span><span><span> (</span></span><span><span>Test-Connection</span></span> <span><span>-ComputerName</span></span> <span><span>$HostName</span></span> <span><span>-Quiet</span></span><span><span>)) {</span></span></span></span><br/><span><span>        <span><span>throw</span></span> <span><span>"Could not stop process </span></span><span><span>$(</span></span><span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name)</span></span><span><span> on remote computer </span></span><span><span>$(</span></span><span><span>$Event</span></span><span><span>.</span></span><span><span>SourceHost</span></span><span><span>.</span></span><span><span>Name)</span></span><span><span> because the computer was not available."</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>$Args</span></span> <span><span>=</span></span><span><span> @{</span></span></span></span><br/><span><span><span><span>        ComputerName </span></span><span><span>=</span></span> <span><span>$HostName</span></span></span></span><br/><span><span><span><span>        Authentication </span></span><span><span>=</span></span> <span><span>"Kerberos"</span></span></span></span><br/><span><span><span><span>        ScriptBlock </span></span><span><span>=</span></span><span><span>  { </span></span><span><span>Stop-Process</span></span> <span><span>-Name</span></span> <span><span>$Args</span></span><span><span>[</span></span><span><span>0</span></span><span><span>]</span></span> <span><span>-Force</span></span><span><span> }</span></span></span></span><br/><span><span><span><span>        ArgumentList </span></span><span><span>=</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name</span></span><span><span>.</span></span><span><span>ToLower()</span></span><span><span>.</span></span><span><span>TrimEnd(</span></span><span><span>'.exe'</span></span><span><span>)</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>if</span></span><span><span> (</span></span><span><span>$Credential</span></span> <span><span>-ne</span></span> <span><span>$null</span></span><span><span>) {</span></span></span></span><br/><span><span>        <span><span>$Args</span></span><span><span>[</span></span><span><span>"Credential"</span></span><span><span>]</span></span> <span><span>=</span></span> <span><span>$Credential</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>Invoke-Command</span></span> <span><span>@Args</span></span></span></span><br/><span><span><span><span>}</span></span></span></span><br/><span><span>------ END of shell -----</span></span><br/> </p>
<p><span><span><strong><span>Instructions:</span></strong><span>  Create a playbook with a PowerShell Runtime. Use the below script. This will generate logs files containing </span></span></span></p>
<ol><li><span><span><span>The Threat Data (which caused the action to run)</span></span></span></li><li><span><span><span>The Event Data, and </span></span></span></li><li><span><span><span>The Hostname</span></span></span></li></ol>
<p><span><span><span>and store them in C:\ProgramData\STEALTHbits\StealthDEFEND.</span></span></span><br/><br/><span><span><span>Be sure to also collect the standard Action Service log file from [InstallPath]\ StealthDEFEND\ActionService\Log (C:\ProgramData\STEALTHbits\StealthDEFEND\ActionService\Log by default)<br/><br/>------ Start of shell -----</span></span></span><br/><br/><span><span><span><span>$Threat</span></span> <span><span>=</span></span> <span><span>Get-SDThreat</span></span> <span><span>-id</span></span> <span><span>$ThreatId</span></span> <span><span>-RestApiUri</span></span> <span><span>$SDRestApiUri</span></span> <span><span>-RestApiToken</span></span> <span><span>$SDRestApiToken</span></span></span></span><br/><span><span><span><span>$Event</span></span> <span><span>=</span></span> <span><span>Get-SDEvent</span></span> <span><span>-Id</span></span> <span><span>$Threat</span></span><span><span>.</span></span><span><span>PrimaryEventId </span></span><span><span>-RestApiUri</span></span> <span><span>$SDRestApiUri</span></span> <span><span>-RestApiToken</span></span> <span><span>$SDRestApiToken</span></span></span></span><br/><br/><span><span><span><span>$HostName</span></span> <span><span>=</span></span> <span><span>Get-ShortSamAccountName</span></span> <span><span>-SamAccountName</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>SourceHost</span></span><span><span>.</span></span><span><span>Name</span></span></span></span><br/><br/><span><span><span><span>$Threat</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\threat.log"</span></span></span></span><br/><span><span><span><span>$Event</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\event.log"</span></span></span></span><br/><span><span><span><span>$HostName</span></span> <span><span>&gt;&gt;</span></span> <span><span>"C:\ProgramData\STEALTHbits\StealthDEFEND\hostname.log"</span></span></span></span><br/><br/><br/><span><span><span><span>if</span></span><span><span> (</span></span><span><span>$env:COMPUTERNAME</span></span> <span><span>-Like</span></span> <span><span>$HostName</span></span><span><span>) {</span></span></span></span><br/><span><span>    <span><span>Stop-Process</span></span> <span><span>-Name</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name</span></span><span><span>.</span></span><span><span>ToLower()</span></span><span><span>.</span></span><span><span>TrimEnd(</span></span><span><span>'.exe'</span></span><span><span>) </span></span><span><span>-Force</span></span></span></span><br/><span><span><span><span>} </span></span><span><span>else</span></span><span><span> {</span></span></span></span><br/><span><span>    <span><span>if</span></span><span><span> (</span></span><span><span>-not</span></span><span><span> (</span></span><span><span>Test-Connection</span></span> <span><span>-ComputerName</span></span> <span><span>$HostName</span></span> <span><span>-Quiet</span></span><span><span>)) {</span></span></span></span><br/><span><span>        <span><span>throw</span></span> <span><span>"Could not stop process </span></span><span><span>$(</span></span><span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name)</span></span><span><span> on remote computer </span></span><span><span>$(</span></span><span><span>$Event</span></span><span><span>.</span></span><span><span>SourceHost</span></span><span><span>.</span></span><span><span>Name)</span></span><span><span> because the computer was not available."</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>$Args</span></span> <span><span>=</span></span><span><span> @{</span></span></span></span><br/><span><span><span><span>        ComputerName </span></span><span><span>=</span></span> <span><span>$HostName</span></span></span></span><br/><span><span><span><span>        Authentication </span></span><span><span>=</span></span> <span><span>"Kerberos"</span></span></span></span><br/><span><span><span><span>        ScriptBlock </span></span><span><span>=</span></span><span><span>  { </span></span><span><span>Stop-Process</span></span> <span><span>-Name</span></span> <span><span>$Args</span></span><span><span>[</span></span><span><span>0</span></span><span><span>]</span></span> <span><span>-Force</span></span><span><span> }</span></span></span></span><br/><span><span><span><span>        ArgumentList </span></span><span><span>=</span></span> <span><span>$Event</span></span><span><span>.</span></span><span><span>Process</span></span><span><span>.</span></span><span><span>Name</span></span><span><span>.</span></span><span><span>ToLower()</span></span><span><span>.</span></span><span><span>TrimEnd(</span></span><span><span>'.exe'</span></span><span><span>)</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>if</span></span><span><span> (</span></span><span><span>$Credential</span></span> <span><span>-ne</span></span> <span><span>$null</span></span><span><span>) {</span></span></span></span><br/><span><span>        <span><span>$Args</span></span><span><span>[</span></span><span><span>"Credential"</span></span><span><span>]</span></span> <span><span>=</span></span> <span><span>$Credential</span></span></span></span><br/><span><span><span><span>    }</span></span></span></span><br/><br/><span><span>    <span><span>Invoke-Command</span></span> <span><span>@Args</span></span></span></span><br/><span><span><span><span>}</span></span></span></span><br/><br/><span><span>------ END of shell -----</span></span><br/> </p>
<p><span><span><strong>Submitted by:</strong> Matt Johnson </span></span><br/><span><span><strong>Product:</strong> StealthDEFEND</span></span><br/><span><span><strong>Affected Versions:</strong> All</span></span><br/><span><span><strong>Affected Module:</strong>  Actions</span></span><br/><span><span><strong>Dev Ticket:</strong> N/A<br/><strong>Resolved In Version:</strong> N/A</span></span><br/><span><span><strong>KB Type:</strong> How To</span></span><br/><strong><span class="wysiwyg-font-size-large">Salesforce Article ID:</span></strong> 000002568</p></div>
</article></body></html>