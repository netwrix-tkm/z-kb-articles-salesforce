<?xml version="1.0" encoding="UTF-8"?><html><head><meta charset="utf-8"/><title>PowerShell Data Collector: How to multi thread a query</title><meta name="label" content="employees_v"/><meta name="label" content="skb"/><meta name="KnowledgeArticleId" content="kA04u0000000It2CAE"/><meta name="Id" content="ka04u000000HcxiAAC"/><meta name="LastPublishedDate" content="2022-02-01T18:38:31.000+0000"/><meta name="LastModifiedDate" content="2023-05-08T10:12:18.000+0000"/><meta name="FirstPublishedDate" content="2022-02-01T18:38:31.000+0000"/><meta name="Language" content="en_US"/><meta name="UrlName" content="7280"/><meta name="ArticleNumber" content="000007280"/><meta name="description" content="360008408371"/></head><body><article class=" kb-articles"><div class="Content__c"><p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> This article describes how to run multiple threads within a single PowerShell query</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Sample code as follows:<br/><br/><span><span><span>#VARIABLES</span></span></span><br/><span><span>       <span>$Threadobject</span> <span>=</span> @()  </span></span><br/><span><span>       <span>$Threadcount</span> <span>=</span> <span>10</span></span></span><br/> <br/><span><span><span>#CONSTANTS    </span></span></span><br/><span><span><span>$ThreadGroup</span></span></span><span><span> <span>=</span> <span>1</span> <span>#Don't change </span></span></span><br/> <br/><span><span>    <span>#divide the total threads into groups</span></span></span><br/><span><span>    <span>$ThreadGroupCount</span> <span>=</span> <span>[</span><span>math</span><span>]::</span>ceiling(<span>$inputsize</span><span>.</span>count <span>/</span> <span>$Threadcount</span> )</span></span><br/> <br/><span><span>    <span>$Counter</span> <span>=</span> <span>0</span></span></span><br/><span><span>    <span>foreach</span> (<span>$i</span> <span>in</span> <span>$input</span>){</span></span><br/><span><span>        <span>$counter</span><span>++</span></span></span><br/><span><span>        <span>#add in any extra columns you want to pass to the thread from $i</span></span></span><br/><span><span>        <span>$result</span> <span>=</span> <span>""</span> <span>|</span> <span>Select</span> <span>Counter</span><span>,</span><span>ThreadGroup</span></span></span><br/> <br/><span><span>        <span>#number the threads and count thread groups. Should all groups take the same amount of time execute this can be handy.</span></span></span><br/><span><span>        <span>$result</span><span>.</span>Counter <span>=</span> <span>$counter</span></span></span><br/><span><span>        <span>$result</span><span>.</span>ThreadGroup <span>=</span> <span>$ThreadGroup</span> <span>-</span> <span>1</span></span></span><br/> <br/><span><span>        <span>#POPULATE THREAD OBJECT WITH SCOPE FOR EACH THREAD</span></span></span><br/><span><span>        <span>$ThreadObject</span> <span>+=</span> <span>$result</span></span></span><br/> <br/><span><span>        <span>If</span> ((<span>$counter</span> <span>%</span> <span>$Threadcount</span> ) <span>-eq</span> <span>0</span>) {</span></span><br/><span><span>           <span>$ThreadGroup</span><span>++</span></span></span><br/><span><span>        }</span></span><br/> <br/><span><span>}</span></span><br/> <br/><span><span><span>#FUNCTIONS</span></span></span><br/><span><span>       <span>function</span> <span>ForEach-Parallel</span> {</span></span><br/><span><span>           <span>param</span>(</span></span><br/><span><span>                  <span>[</span><span>Parameter</span>(Mandatory<span>=</span><span>$true</span><span>,</span>position<span>=</span><span>0</span>)<span>]</span> <span>[</span><span>System.Management.Automation.ScriptBlock</span><span>]</span> <span>$ScriptBlock</span><span>,</span></span></span><br/><span><span>                  <span>[</span><span>Parameter</span>(Mandatory<span>=</span><span>$true</span><span>,</span>ValueFromPipeline<span>=</span><span>$true</span>)<span>]</span> <span>[</span><span>PSObject</span><span>]</span><span>$InputObject</span><span>,</span></span></span><br/><span><span>                  <span>[</span><span>Parameter</span>(Mandatory<span>=</span><span>$true</span>)<span>]</span> <span>[</span><span>int</span><span>]</span><span>$MaxThreads</span><span>=</span><span>$ThreadCount</span></span></span><br/><span><span>        )</span></span><br/><span><span>           <span>BEGIN</span> {</span></span><br/><span><span>                  <span>$iss</span> <span>=</span> <span>[</span><span>system.management.automation.runspaces.initialsessionstate</span><span>]::</span>CreateDefault()</span></span><br/><span><span>                  <span>$pool</span> <span>=</span> <span>[</span><span>Runspacefactory</span><span>]::</span>CreateRunspacePool(<span>1</span><span>,</span> <span>$maxthreads</span><span>,</span> <span>$iss</span><span>,</span> <span>$host</span>)</span></span><br/><span><span>                  <span>$pool</span><span>.</span>open()</span></span><br/><span><span>                  <span>$threads</span> <span>=</span> @()</span></span><br/><span><span>                  <span>$ScriptBlock</span> <span>=</span> <span>$ExecutionContext</span><span>.</span>InvokeCommand<span>.</span>NewScriptBlock(<span>"param(`$_)`r`n"</span> <span>+</span> <span>$Scriptblock</span><span>.</span>ToString())</span></span><br/><span><span>           }</span></span><br/><span><span>           <span>PROCESS</span> {</span></span><br/><span><span>                  <span>$powershell</span> <span>=</span> <span>[</span><span>powershell</span><span>]::</span>Create()<span>.</span>addscript(<span>$scriptblock</span>)<span>.</span>addargument(<span>$InputObject</span>)</span></span><br/><span><span>                  <span>$powershell</span><span>.</span>runspacepool<span>=</span><span>$pool</span></span></span><br/><span><span>                  <span>$threads</span><span>+=</span> @{</span></span><br/><span><span>                      instance <span>=</span> <span>$powershell</span></span></span><br/><span><span>                      handle <span>=</span> <span>$powershell</span><span>.</span>begininvoke()</span></span><br/><span><span>                  }</span></span><br/> <br/><span><span>           }</span></span><br/><span><span>           <span>END</span> {</span></span><br/><span><span>                  <span>$notdone</span> <span>=</span> <span>$true</span></span></span><br/><span><span>            <span>#while we have not hit the max thread count, loop and create threads</span></span></span><br/><span><span>                  <span>while</span> (<span>$notdone</span>) {</span></span><br/><span><span>                      <span>$notdone</span> <span>=</span> <span>$false</span></span></span><br/><span><span>                      <span>for</span> (<span>$i</span><span>=</span><span>0</span>; <span>$i</span> <span>-lt</span> <span>$threads</span><span>.</span>count; <span>$i</span><span>++</span>) {</span></span><br/><span><span>                             <span>$thread</span> <span>=</span> <span>$threads</span><span>[</span><span>$i</span><span>]</span></span></span><br/><span><span>                    <span>#if a thread is created</span></span></span><br/><span><span>                             <span>if</span> (<span>$thread</span>) {</span></span><br/> <br/><span><span>                        <span>#debug, output pool and thread id</span></span></span><br/><span><span>                        <span>#write-host "pool instance: "$pool.instanceid "Thread instance:" $Thread.instance.instanceid</span></span></span><br/> <br/><span><span>                        <span>#check if thread is complete. if so clean it up</span></span></span><br/><span><span>                                 <span>if</span> (<span>$thread</span><span>.</span>handle<span>.</span>iscompleted) {</span></span><br/><span><span>                                       <span>$thread</span><span>.</span>instance<span>.</span>endinvoke(<span>$thread</span><span>.</span>handle)</span></span><br/><span><span>                                       <span>$thread</span><span>.</span>instance<span>.</span>dispose()</span></span><br/><span><span>                                       <span>$threads</span><span>[</span><span>$i</span><span>]</span> <span>=</span> <span>$null</span></span></span><br/><span><span>                                 }</span></span><br/><span><span>                             }</span></span><br/><span><span>                      }</span></span><br/><span><span>                  }</span></span><br/><span><span>           }</span></span><br/><span><span>}</span></span><br/> <br/><span><span><span>#MAIN</span></span></span><br/> <br/><span><span><span>#start X number of threads, passing in thread object</span></span></span><br/><span><span><span>$ThreadObject</span></span></span><span><span> <span>|</span> <span>ForEach-Parallel</span> <span>-MaxThreads</span> <span>$Threadcount</span> {</span></span><br/><span><span>           <span>#PUT CODE FOR EACH THREAD HERE</span></span></span><br/>          <br/><span><span>        <span>#start task manager and show the thread and handle count, observe thread count increases proportionate to $threadcount</span></span></span><br/> <br/><span><span>        <span>#Reference scoping settings in $threadobject to set what each thread is supposed to tackle.</span></span></span><br/><span><span>           <span>#You can reference the scoping items by $_.[FieldName]</span></span></span><br/> <br/><span><span>        <span>#proof it is running threaded, output is out of order when using write-host. Executing more than just the line below can cause them to come out ordered.</span></span></span><br/><span><span>        <span>#write-host "counter:" $_.counter</span></span></span><br/>      <br/><span><span>        <span>#This will return all rows from the passing object, one for each thread, since each thread will have been passed one row to it</span></span></span><br/><span><span>        <span>#$ThreadObject</span></span></span><br/> <span><span>}</span></span><br/> </p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong></p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br/><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - DC - PowerShell<br/><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> V6.x, V7.x<br/><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 1454</p></div>
</article></body></html>